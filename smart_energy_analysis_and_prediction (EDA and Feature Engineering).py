# -*- coding: utf-8 -*-
"""Smart_Energy_Analysis_and_Prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/17qMuHA9OWBGgbOD43gI1R7a1z3xHBFiS

**Exploratory Data Analysis (EDA)**

**1. Data Understanding**
"""

#Import Libraries and Load Data
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

df = pd.read_csv("Energy_consumption.csv")

df.head()

df.shape

df.info()

#Column Description
df.columns

#Descriptive Statistics
df.describe()

df.describe(include="object")

df.nunique()

"""**2. Data Preparation**"""

#convert object type to datetime
df['Time'] = pd.to_datetime(df['Timestamp'])

df.drop('Timestamp', axis=1, inplace=True)
df.columns

# Missing Values Analysis
df.isnull().sum()

sns.heatmap(df.isnull(), cbar=False)
plt.title("Missing Values Heatmap")
plt.show()

#check for duplicates
print(df.duplicated().sum())

'''Outlier Detection'''
#IQR method
numeric_cols = df.select_dtypes(include=np.number).columns

Q1 = df[numeric_cols].quantile(0.25)
Q3 = df[numeric_cols].quantile(0.75)
IQR = Q3 - Q1

outliers = ((df[numeric_cols] < (Q1 - 1.5 * IQR)) |
            (df[numeric_cols] > (Q3 + 1.5 * IQR))).sum()

outliers

"""**3. Feature Understanding**

Univariate Analysis
---


"""

#  (a) Target Variable: EnergyConsumption
plt.figure(figsize=(6,4))
sns.histplot(df["EnergyConsumption"], bins=30, kde=True)
plt.title("Distribution of Energy Consumption")
plt.xlabel("Energy Consumption")
plt.ylabel("Frequency")
plt.show()

"""*   **Energy consumption** follows an approximately normal distribution.
*   Most energy values lie between **70 and 85 units**, indicating a stable average usage pattern.
*   This distribution suggests that **regression-based** machine learning models are suitable for prediction.





"""

plt.figure(figsize=(5,3))
sns.boxplot(x=df["EnergyConsumption"])
plt.title("Boxplot of Energy Consumption")
plt.show()

# (b) Temperature
plt.figure(figsize=(6,4))
sns.histplot(df["Temperature"], bins=30, kde=True)
plt.title("Temperature Distribution")
plt.show()

"""Most temperatures are concentrated between **22°C and 28°C**, with a peak around **24–25°C**.

The distribution is fairly smooth with no extreme spikes, indicating stable temperature variations
"""

sns.boxplot(x=df["Temperature"])
plt.title("Temperature Outliers")
plt.show()

# (c) Humidity
plt.figure(figsize=(6,4))
sns.histplot(df["Humidity"], bins=30, kde=True)
plt.title("Humidity Distribution")
plt.show()

"""**Humidity** values are mostly concentrated between **40% and 55%**, peaking around 48–50%."""

sns.boxplot(x=df["Humidity"])
plt.title("Humidity Outliers")
plt.show()

# (d) Square Footage
plt.figure(figsize=(6,4))
sns.histplot(df["SquareFootage"], bins=30, kde=True)
plt.title("House Size Distribution")
plt.show()

"""**House sizes** are spread fairly evenly between **1000 and 2000 sq ft**, with mild
peaks around 1200–1300 and 1600–1800 sq ft.
"""

sns.boxplot(x=df["SquareFootage"])
plt.title("Square Footage Outliers")
plt.show()

# (e) Occupancy
plt.figure(figsize=(6,4))
sns.countplot(x="Occupancy", data=df)
plt.title("Occupancy Count")
plt.show()

"""**Higher occupancy** values (around 6–8 people) appear slightly more common, which may lead to **higher energy usage**"""

# (f) Renewable Energy
plt.figure(figsize=(6,4))
sns.histplot(df["RenewableEnergy"], bins=30, kde=True)
plt.title("Renewable Energy Generation")
plt.show()

"""Slightly higher frequencies appear in the mid to higher range, suggesting moderate-to-high generation levels are more common than very low values."""

# (g) HVAC Usage
plt.figure(figsize=(6,4))
sns.countplot(x="HVACUsage", data=df)
plt.title("HVAC Usage Frequency")
plt.show()

# (h) Lighting Usage
plt.figure(figsize=(6,4))
sns.countplot(x="LightingUsage", data=df)
plt.title("Lighting Usage Frequency")
plt.show()

# (i) Day of Week
plt.figure(figsize=(7,4))
sns.countplot(x="DayOfWeek", data=df)
plt.title("Energy Records by Day")
plt.show()

"""**Friday** has the highest number of records, indicating more activity or data collection on that day."""

# (j) Holiday
plt.figure(figsize=(5,4))
sns.countplot(x="Holiday", data=df)
plt.title("Holiday Distribution")
plt.show()

"""1.   Non-holiday days have more records than holidays, meaning most data comes from regular days.


2.   The number of holiday records is still significant, so **holidays should be considered in analysis** as they may affect energy usage patterns.

**4. FEATURE RELATIONSHIPS**
"""

# (a) Energy Consumption vs Temperature
plt.figure()
plt.scatter(df['Temperature'], df['EnergyConsumption'], alpha=0.5)
plt.xlabel('Temperature')
plt.ylabel('Energy Consumption')
plt.title('Energy Consumption vs Temperature')
plt.show()

"""

1.   There is a positive relationship: as temperature increases, energy consumption generally increases.


2.   The upward trend suggests **temperature is an important factor** influencing energy consumption

"""

# (b) Humidity vs Energy Consumption
sns.scatterplot(x="Humidity", y="EnergyConsumption", data=df)
plt.title("Humidity vs Energy Consumption")
plt.show()

"""

1.   There is no clear trend between humidity and energy consumption; the points are widely scattered.


2.   **Humidity** appears to be a **weaker factor** compared to temperature in influencing energy consumption.

"""

# (c) Square Footage vs Energy Consumption
sns.scatterplot(x="SquareFootage", y="EnergyConsumption", data=df)
plt.title("House Size vs Energy Consumption")
plt.show()

"""

1.   There is **no strong linear relationship** between house size and energy consumption in this data.


2.   Houses of different sizes show similar energy usage ranges, suggesting other factors influence consumption more than size alone.

"""

# (d) Occupancy vs Energy Consumption
plt.figure()
plt.scatter(df['Occupancy'], df['EnergyConsumption'], alpha=0.5)
plt.xlabel('Occupancy')
plt.ylabel('Energy Consumption')
plt.title('Energy vs Occupancy')
plt.show()

"""

1.   Energy consumption **generally increases with higher occupancy**, showing a positive trend.


2.   There is noticeable variation at each occupancy level, meaning **occupancy affects usage but is not the only factor**.

"""

# (e) HVAC Usage vs Energy Consumption
plt.figure()
plt.scatter(df['HVACUsage'], df['EnergyConsumption'], alpha=0.5)
plt.xlabel('HVAC Usage')
plt.ylabel('Energy Consumption')
plt.title('HVAC Usage vs Energy Consumption')
plt.show()

"""

1.   Energy consumption is generally higher when HVAC is ON, showing its **strong impact on usage**.


2.   When HVAC is OFF, consumption is lower and more spread out, indicating baseline energy use from other appliances.

"""

# (f) Renewable Energy vs Consumption
plt.figure()
plt.scatter(df['RenewableEnergy'], df['EnergyConsumption'], alpha=0.5)
plt.xlabel('Renewable Energy')
plt.ylabel('Energy Consumption')
plt.title('Renewable Energy vs Consumption')
plt.show()

"""

1.   **Weak or no clear correlation:** Energy consumption is almost the same even when renewable energy increases.
2.   So renewable energy alone **does not control total usage**.

"""

#Pairplots
pair_cols = [
    'Temperature', 'Occupancy', 'HVACUsage',
    'RenewableEnergy', 'EnergyConsumption'
]

sample_df = df[pair_cols].sample(df.shape[0], random_state=42)

sns.pairplot(sample_df)
plt.show()

"""

1.   **Temperature** is a key driver of energy usage.
2.   **Occupancy** directly impacts consumption.
1.   **Renewable energy** does not reduce demand automatically.
2.   **Energy consumption** follows a stable pattern -> *good for ML forecasting and anomaly detection at device level*
1.   **Weak interaction** between renewables and devices -> *Devices consume energy independent of renewable input → highlights need for intelligent scheduling and prioritization.*






"""

#Correlation heatmap
plt.figure(figsize=(10,6))
sns.heatmap(df[numeric_cols].corr(), annot=True, cmap="Greens")
plt.title("Feature Correlation Heatmap")
plt.show()

"""1.  **Temperature** is the **strongest predictor** of energy consumption (0.70)
2.   **Occupancy** has a moderate impact (0.19)


1.   **Renewable energy** has **weak correlation** with consumption (0.08)
2.   **Humidity** and **house size** have negligible impact


1.   **Low multicollinearity** between features : Features are mostly independent → good for stable ML models.

**5. Analysis plots**
"""

#Energy Consumption Trend Over Time
plt.figure(figsize=(10,4))
plt.plot(df["Time"], df["EnergyConsumption"])
plt.title("Energy Consumption Over Time")
plt.xlabel("Time")
plt.ylabel("Energy Consumption")
plt.show()

"""

1.   **Energy consumption** follows repeating patterns over time
2.   Confirms time dependency
1.   **Feature engineering:** Hour, Day, PeakTime



"""

#Day of Week vs Energy Consumption
plt.figure(figsize=(8,4))
sns.boxplot(x="DayOfWeek", y="EnergyConsumption", data=df)
plt.title("Energy Consumption by Day of Week")
plt.show()

"""

1.   Certain days show higher usage
1.   Human behavior matters
2.   **Feature engineering:** IsWeekend, day encoding"""

#Holiday vs Non-Holiday
plt.figure(figsize=(5,4))
sns.boxplot(x="Holiday", y="EnergyConsumption", data=df)
plt.title("Holiday vs Non-Holiday Energy Consumption")
plt.show()

"""

1.   Holidays show different energy behavior
2.   Important contextual feature
1.   **Feature engineering:** holiday indicator




"""

#HVAC Usage During Peak vs Non-Peak Hours
df["Hour"] = df["Time"].dt.hour

df["PeakHour"] = df["Hour"].apply(
    lambda x: "Peak" if (6 <= x <= 10 or 18 <= x <= 22) else "Non-Peak"
)

plt.figure(figsize=(6,4))
sns.countplot(x="HVACUsage", hue="PeakHour", data=df)
plt.title("HVAC Usage During Peak vs Non-Peak Hours")
plt.show()

"""1.   **HVAC usage** is significantly higher during peak hours
2.   Indicates human comfort-driven behavior
1.   **Feature engineering:** IsPeakHour, HVAC_Peak_Usage
"""

#Temperature × HVAC Impact on Energy
sns.scatterplot(
    x="Temperature",
    y="EnergyConsumption",
    hue="HVACUsage",
    data=df,
    alpha=0.6
)
plt.title("Temperature vs Energy Consumption (HVAC Impact)")
plt.show()

"""1.   **Energy consumption** spikes when temperature is **high** AND HVAC is **ON**
2.   Justifies interaction features like **Temp × HVAC**
"""

#Occupancy Impact When HVAC is ON
sns.boxplot(
    x="Occupancy",
    y="EnergyConsumption",
    hue="HVACUsage",
    data=df
)
plt.title("Occupancy vs Energy Consumption (HVAC Effect)")
plt.show()

"""1.   **High occupancy + HVAC ON** → maximum energy usage
2.   Occupancy alone is not enough; device context matters

**CONCLUSION**

---



**Energy consumption** is primarily driven by t**emperature-dependent HVAC usage**, amplified by **occupancy and time-based behavior**, while **renewable energy** requires ML-based optimization to effectively reduce demand.
"""





"""**FEATURE ENGINEERING**"""

df = df.sort_values('Time').reset_index(drop=True)

# Convert 'HVACUsage' and 'LightingUsage' to numerical (0/1)
df['HVACUsage'] = df['HVACUsage'].map({'Off': 0, 'On': 1}).fillna(0)
df['LightingUsage'] = df['LightingUsage'].map({'Off': 0, 'On': 1}).fillna(0)

# ---- Environmental & Occupancy Impact ----
df['Thermal_Energy_Load'] = df['Temperature'] * df['HVACUsage']
df['Occupancy_Energy_Load'] = df['Occupancy'] * df['HVACUsage']

df['Environmental_Stress_Level'] = (
    (df['Temperature'] - 24).abs() +
    (df['Humidity'] - 50).abs()
)

# ---- Daily Usage Cycle ----
df['Hour'] = df['Time'].dt.hour
df['Daily_Usage_Sin'] = np.sin(2 * np.pi * df['Hour'] / 24)
df['Daily_Usage_Cos'] = np.cos(2 * np.pi * df['Hour'] / 24)

df['HVAC_Stress'] = df['HVACUsage'] * df['HVACUsage'] * df['Temperature']
df['Lighting_Demand_Intensity'] = df['LightingUsage'] * df['Occupancy']
df['Is_Peak_Hour'] = df['Hour'].isin([6,7,8,9,18,19,20,21]).astype(int)

df['HVAC_On_Peak'] = df['Is_Peak_Hour'] * (df['HVACUsage'] > 0).astype(int)

df['Temp_Bucket'] = pd.cut(
    df['Temperature'],
    bins=[0, 18, 22, 26, 30, 100],
    labels=[0, 1, 2, 3, 4]
).astype(int)

df = df.dropna().reset_index(drop=True)

# ---- Final Feature Set ----
features = [
    'Temperature','Humidity','Occupancy',
    'HVACUsage','LightingUsage',

    'Thermal_Energy_Load',
    'Occupancy_Energy_Load',
    'Environmental_Stress_Level',

    'HVAC_On_Peak',
    'Temp_Bucket',

    'Daily_Usage_Sin',
    'Daily_Usage_Cos',

    'HVAC_Stress',
    'Lighting_Demand_Intensity',
    'Is_Peak_Hour',

]


X = df[features]
y = df['EnergyConsumption']

!pip install catboost

from sklearn.model_selection import train_test_split
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
from sklearn.linear_model import LinearRegression
from sklearn.tree import DecisionTreeRegressor
from sklearn.ensemble import RandomForestRegressor, GradientBoostingRegressor
from lightgbm import LGBMRegressor
from xgboost import XGBRegressor
from catboost import CatBoostRegressor

models = {
    "Decision Tree": DecisionTreeRegressor(max_depth=8, random_state=42),
    "Random Forest": RandomForestRegressor(n_estimators=350, max_depth=10, random_state=42),
    "Gradient Boosting": GradientBoostingRegressor(
        n_estimators=400, learning_rate=0.04, max_depth=3, random_state=42
    ),
    "LightGBM": LGBMRegressor(
        n_estimators=600, learning_rate=0.04, max_depth=5, random_state=42
    ),
    "XGBoost": XGBRegressor(
        n_estimators=700, learning_rate=0.04, max_depth=5,
        subsample=0.9, colsample_bytree=0.9,
        objective='reg:squarederror', random_state=42
    ),
    "CatBoost": CatBoostRegressor(
        iterations=700, learning_rate=0.04, depth=5,
        loss_function='RMSE', verbose=0, random_seed=42
    )
}

results = []

for name, model in models.items():
    model.fit(X_train, y_train)
    preds = model.predict(X_test)
    results.append({
        "Model": name,
        "MAE": mean_absolute_error(y_test, preds),
        "RMSE": np.sqrt(mean_squared_error(y_test, preds)),
        "R2": r2_score(y_test, preds)
    })

results_df = pd.DataFrame(results).sort_values("R2", ascending=False)
print(results_df)

import pickle

with open("catboost_energy_model.pkl", "wb") as f:
    pickle.dump(models['CatBoost'], f)