<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartEnergy AI - Energy Consumption Prediction</title>
    <!-- Add Bootstrap CSS -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c2461, #1e3799);
            color: white;
            min-height: 100vh;
        }

        /* Contact Us Page Styles */
        .contact-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 50px 20px;
        }

        .contact-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .contact-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .contact-header h2 {
            color: #78e08f;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .contact-form .form-group {
            margin-bottom: 20px;
        }

        .contact-form label {
            display: block;
            margin-bottom: 8px;
            color: #78e08f;
            font-weight: 500;
        }

        .contact-form input,
        .contact-form textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .contact-form input:focus,
        .contact-form textarea:focus {
            outline: none;
            border-color: #78e08f;
            box-shadow: 0 0 0 2px rgba(120, 224, 143, 0.2);
        }

        .contact-form textarea {
            min-height: 150px;
            resize: vertical;
        }

        .contact-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #78e08f, #4a69bd);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-top: 10px;
        }

        .contact-btn:hover {
            transform: scale(1.05);
        }

        .required-note {
            color: #a5b1c2;
            font-size: 14px;
            margin-top: 15px;
            text-align: center;
        }

        .how-it-works {
            margin-top: 40px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border-left: 4px solid #78e08f;
        }

        .how-it-works h5 {
            color: #78e08f;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .how-it-works ol {
            padding-left: 20px;
            color: #d1d8e0;
        }

        .how-it-works li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* Flash Messages Styles */
        .alert-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .alert-message.show {
            display: block;
        }

        .alert-success {
            background: rgba(120, 224, 143, 0.2);
            border: 1px solid #78e08f;
            color: #78e08f;
        }

        .alert-error {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }

        .alert-warning {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            color: #ffd700;
        }

        .alert-close {
            background: none;
            border: none;
            color: inherit;
            float: right;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            margin-left: 15px;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo h1 {
            font-size: 36px;
            background: linear-gradient(45deg, #78e08f, #4a69bd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .login-logo p {
            color: #d1d8e0;
            font-size: 14px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: #78e08f;
            font-weight: 500;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .login-form input:focus {
            outline: none;
            border-color: #78e08f;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #78e08f, #4a69bd);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: scale(1.05);
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
            color: #d1d8e0;
        }

        .register-link a {
            color: #78e08f;
            text-decoration: none;
            font-weight: 500;
        }

        /* Error Modal */
        .error-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2001;
            justify-content: center;
            align-items: center;
        }

        .error-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .error-modal-content {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 2px solid #ff8e8e;
        }

        .error-modal-icon {
            font-size: 60px;
            color: white;
            margin-bottom: 20px;
        }

        .error-modal-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: white;
        }

        .error-modal-content p {
            color: white;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .error-modal-close-btn {
            background: white;
            color: #ff6b6b;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
        }

        /* File Error Modal */
        .file-error-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2002;
            justify-content: center;
            align-items: center;
        }

        .file-error-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .file-error-modal-content {
            background: linear-gradient(135deg, #ff9800, #ff5722);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 2px solid #ffcc80;
        }

        .file-error-modal-icon {
            font-size: 60px;
            color: white;
            margin-bottom: 20px;
        }

        .file-error-modal-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: white;
        }

        .file-error-modal-content p {
            color: white;
            margin-bottom: 20px;
            opacity: 0.9;
            line-height: 1.5;
        }

        .file-error-modal-content ul {
            text-align: left;
            color: white;
            margin: 15px 0;
            padding-left: 20px;
        }

        .file-error-modal-content li {
            margin-bottom: 8px;
        }

        .file-error-modal-close-btn {
            background: white;
            color: #ff9800;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
        }

        /* Main Website Styles */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 5%;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: none;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: #4a69bd;
            display: flex;
            align-items: center;
        }

        .logo span {
            color: #78e08f;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #78e08f;
        }

        .nav-links a.active {
            background: #4a69bd;
            color: white;
        }

        .profile-icon {
            position: relative;
            cursor: pointer;
        }

        .profile-icon i {
            font-size: 24px;
            color: #78e08f;
            transition: color 0.3s ease;
        }

        .profile-icon:hover i {
            color: white;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(30, 55, 153, 0.95);
            border-radius: 10px;
            padding: 20px;
            min-width: 250px;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(120, 224, 143, 0.3);
            z-index: 1001;
        }

        .profile-dropdown.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #78e08f, #4a69bd);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
            color: white;
        }

        .profile-info p {
            font-size: 14px;
            color: #d1d8e0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .profile-details {
            margin-bottom: 20px;
        }

        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .profile-label {
            color: #a5b1c2;
            font-size: 14px;
        }

        .profile-value {
            color: white;
            font-weight: 500;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #78e08f;
        }

        .stat-label {
            font-size: 12px;
            color: #a5b1c2;
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .hero {
            padding: 80px 5%;
            text-align: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #78e08f, #4a69bd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero p {
            font-size: 20px;
            color: #d1d8e0;
            max-width: 800px;
            margin: 0 auto 40px;
            line-height: 1.6;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            padding: 40px 5%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: transform 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.15);
        }

        .feature-icon {
            font-size: 50px;
            margin-bottom: 20px;
            color: #78e08f;
        }

        .feature-card h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: white;
        }

        .feature-card p {
            color: #d1d8e0;
            line-height: 1.6;
        }

        /* Guide Section Styles */
        .guide-section {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 5%;
        }

        .guide-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
        }

        .guide-step {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 60px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .guide-step:hover {
            transform: translateX(10px);
        }

        .guide-step:nth-child(even) {
            flex-direction: row-reverse;
        }

        .guide-step-number {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #78e08f, #4a69bd);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .guide-step-content {
            flex: 1;
        }

        .guide-step-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #78e08f;
        }

        .guide-step-content p {
            color: #d1d8e0;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .guide-visual {
            width: 300px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 2px dashed rgba(120, 224, 143, 0.3);
        }

        .guide-icon {
            font-size: 80px;
            color: #78e08f;
        }

        /* File Upload Styles */
        .file-upload-section {
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed rgba(120, 224, 143, 0.3);
            transition: all 0.3s ease;
        }

        .file-upload-section.drag-over {
            background: rgba(120, 224, 143, 0.1);
            border-color: #78e08f;
            transform: scale(1.02);
        }

        .file-upload-area {
            text-align: center;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .file-upload-area:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-icon {
            font-size: 60px;
            color: #78e08f;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .file-upload-area:hover .upload-icon {
            transform: translateY(-5px);
        }

        .file-format-info {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .format-badge {
            padding: 5px 15px;
            background: rgba(120, 224, 143, 0.2);
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid rgba(120, 224, 143, 0.3);
        }

        .file-processing {
            text-align: center;
            padding: 20px;
            background: rgba(120, 224, 143, 0.1);
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .file-processing.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .processing-spinner {
            font-size: 30px;
            color: #78e08f;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auto-fill-success {
            background: rgba(120, 224, 143, 0.2);
            border: 2px solid #78e08f;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .auto-fill-success.active {
            display: block;
        }

        .success-icon {
            color: #78e08f;
            font-size: 24px;
            margin-right: 10px;
        }

        .uploaded-file-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(120, 224, 143, 0.1);
            border-radius: 10px;
            display: none;
        }

        .uploaded-file-info.active {
            display: block;
        }

        /* Prediction Section */
        .prediction-section, .reviews-section {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }

        .form-container {
            padding: 40px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            color: #78e08f;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group label i {
            font-size: 18px;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #78e08f;
        }

        .form-group select option {
            background: #0c2461;
            color: white;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .device-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .device-checkbox:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .device-checkbox input {
            margin-right: 5px;
        }

        .submit-btn {
            background: linear-gradient(45deg, #78e08f, #4a69bd);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-top: 20px;
            width: 100%;
        }

        .submit-btn:hover {
            transform: scale(1.05);
        }

        .prediction-result {
            margin-top: 40px;
            padding: 30px;
            background: rgba(120, 224, 143, 0.1);
            border-radius: 10px;
            border-left: 5px solid #78e08f;
            display: none;
        }

        .prediction-result.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        .result-value {
            font-size: 36px;
            font-weight: 700;
            color: #78e08f;
            margin: 10px 0;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-align: center;
        }

        .result-item .value {
            font-size: 20px;
            font-weight: 600;
            color: #78e08f;
        }

        /* Dashboard Section */
        .dashboard-section {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }

        .dashboard-container {
            padding: 40px;
        }

        .dashboard-summary {
            margin-bottom: 30px;
        }

        .dashboard-summary .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-summary .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            transition: transform 0.3s ease;
        }

        .dashboard-summary .dashboard-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .dashboard-summary .dashboard-card h3 {
            font-size: 16px;
            color: #a5b1c2;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .dashboard-card h3 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #78e08f;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            margin-top: 10px;
            position: relative;
        }

        .prediction-history {
            margin-top: 40px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th {
            background: rgba(120, 224, 143, 0.2);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #78e08f;
        }

        .history-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-table tr {
            transition: background 0.3s ease;
        }

        .history-table tr:hover {
            background: rgba(120, 224, 143, 0.1) !important;
            cursor: pointer;
        }

        /* Chart tooltips */
        .chartjs-tooltip {
            background: rgba(0, 0, 0, 0.8) !important;
            border: 1px solid #78e08f !important;
            border-radius: 8px !important;
            color: white !important;
            padding: 10px !important;
        }

        /* AI Assistant Section */
        .ai-assistant-section {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }

        .star-rating {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .star {
            font-size: 30px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star:hover,
        .star.active {
            color: #ffd700;
        }

        .review-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #78e08f;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .review-name {
            font-weight: 600;
            color: #78e08f;
        }

        .review-date {
            color: #a5b1c2;
            font-size: 14px;
        }

        .review-stars {
            color: #ffd700;
            margin: 5px 0;
        }

        .review-text {
            color: #d1d8e0;
            line-height: 1.6;
        }

        .ai-chat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            padding: 15px;
            border-radius: 15px;
            max-width: 80%;
            line-height: 1.5;
        }

        .ai-message {
            background: linear-gradient(135deg, #4a69bd, #1e3799);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .user-message {
            background: linear-gradient(135deg, #78e08f, #38ada9);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .chat-input button {
            background: #4a69bd;
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .voice-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }

        .voice-status {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 36px;
        }

        .mic-level {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #78e08f;
            border-radius: 50%;
            margin-left: 5px;
            animation: micPulse 1s infinite;
        }

        @keyframes micPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .question-chip {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-chip:hover {
            background: rgba(120, 224, 143, 0.2);
            transform: translateY(-2px);
        }

        /* Success Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3799, #0c2461);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 2px solid #78e08f;
        }

        .modal-icon {
            font-size: 60px;
            color: #78e08f;
            margin-bottom: 20px;
        }

        .modal-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: white;
        }

        .modal-content p {
            color: #d1d8e0;
            margin-bottom: 20px;
        }

        .modal-close-btn {
            background: #78e08f;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
        }

        /* Prediction Details Modal */
        .prediction-details-modal {
            max-width: 600px;
        }

        .prediction-details-modal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        footer {
            text-align: center;
            padding: 40px 5%;
            color: #d1d8e0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 60px;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 20px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .hero h1 {
                font-size: 36px;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
            
            .guide-step {
                flex-direction: column !important;
                text-align: center;
            }
            
            .guide-visual {
                width: 100%;
                height: 150px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .form-container, .dashboard-container {
                padding: 20px;
            }
            
            .profile-dropdown {
                position: fixed;
                top: 80px;
                left: 20px;
                right: 20px;
                min-width: auto;
            }

            .dashboard-summary .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .voice-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .contact-container {
                padding: 20px;
            }

            .contact-box {
                padding: 20px;
            }

            .contact-header h2 {
                font-size: 24px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- File Error Modal -->
    <div class="file-error-modal" id="fileErrorModal">
        <div class="file-error-modal-content">
            <div class="file-error-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Invalid File Format!</h3>
            <p>Please upload a relevant energy data file. We support the following formats:</p>
            <ul>
                <li><strong>.txt</strong> - Text files with energy consumption data</li>
                <li><strong>.csv</strong> - CSV files with temperature, occupancy, area, etc.</li>
                <li><strong>.json</strong> - JSON files with structured energy data</li>
                <li><strong>.xlsx</strong> - Excel files with energy consumption records</li>
            </ul>
            <p style="font-size: 14px; margin-top: 15px;">
                <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> Your file should contain data like temperature, number of occupants, area, date, time, and device information.
            </p>
            <button class="file-error-modal-close-btn" onclick="closeFileErrorModal()">OK, Got It</button>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <h1>SmartEnergy<span style="color: #78e08f">AI</span></h1>
                <p>AI-Powered Energy Management Platform</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginUsername"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                
                <button type="button" class="login-btn" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
            
            <div class="register-link">
                <p>Don't have an account? <a href="#" onclick="showRegister()">Register here</a></p>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-logo">
                <h1>Create Account</h1>
                <p>Join SmartEnergy AI Platform</p>
            </div>
            
            <form id="registerForm" class="login-form">
                <div class="form-group">
                    <label for="registerName"><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" id="registerName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="registerEmail"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="registerUsername"><i class="fas fa-user-circle"></i> Username</label>
                    <input type="text" id="registerUsername" placeholder="Choose a username" required>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password" required>
                </div>
                
                <div class="form-group">
                    <label for="registerConfirmPassword"><i class="fas fa-lock"></i> Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" placeholder="Confirm your password" required>
                </div>
                
                <button type="button" class="login-btn" onclick="register()">
                    <i class="fas fa-user-plus"></i> Register
                </button>
            </form>
            
            <div class="register-link">
                <p>Already have an account? <a href="#" onclick="showLogin()">Login here</a></p>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="error-modal" id="errorModal">
        <div class="error-modal-content">
            <div class="error-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Invalid File!</h3>
            <p id="errorMessage">Please upload a valid file format.</p>
            <button class="error-modal-close-btn" onclick="closeErrorModal()">OK</button>
        </div>
    </div>

    <!-- Main Website -->
    <div id="mainWebsite" style="display: none;">
        <nav class="navbar">
            <div class="logo">
                SmartEnergy<span>AI</span>
            </div>
            <div class="nav-links">
                <a href="#" class="active" onclick="showSection('home')">Home</a>
                <a href="#" onclick="showSection('guide')">Guide</a>
                <a href="#" onclick="showSection('predict')">Predict</a>
                <a href="#" onclick="showSection('dashboard')">Dashboard</a>
                <a href="#" onclick="showSection('ai-assistant')">AI Assistant</a>
                <a href="#" onclick="showSection('reviews')">Reviews</a>
                <a href="#" onclick="showSection('contact')">Contact Us</a>
                <div class="profile-icon" onclick="toggleProfileDropdown()">
                    <i class="fas fa-user-circle"></i>
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">U</div>
                            <div class="profile-info">
                                <h3 id="profileName">User Name</h3>
                                <p id="profileEmail">user@example.com</p>
                            </div>
                        </div>
                        <div class="profile-details">
                            <div class="profile-item">
                                <span class="profile-label">Member Since</span>
                                <span class="profile-value" id="profileJoinDate">2024</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">Predictions Made</span>
                                <span class="profile-value" id="profilePredictions">0</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">Energy Saved</span>
                                <span class="profile-value" id="profileEnergySaved">0 kWh</span>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="profileAvgPrediction">0</div>
                                <div class="stat-label">Avg Prediction</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="profileMoneySaved">₹0</div>
                                <div class="stat-label">Money Saved</div>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Home Section -->
        <section id="home" class="section active">
            <div class="hero">
                <h1>Welcome to SmartEnergy AI</h1>
                <p>AI-Powered Energy Management & Prediction Platform. Predict, Analyze, and Optimize your energy consumption using advanced machine learning.</p>
                
                <div class="features">
                    <div class="feature-card" onclick="showSection('guide')">
                        <div class="feature-icon"><i class="fas fa-book"></i></div>
                        <h3>User Guide</h3>
                        <p>Learn how to use our platform with step-by-step instructions and visual guides.</p>
                    </div>
                    
                    <div class="feature-card" onclick="showSection('predict')">
                        <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                        <h3>Energy Prediction</h3>
                        <p>Predict energy consumption based on multiple parameters including devices, occupancy, and time.</p>
                    </div>
                    
                    <div class="feature-card" onclick="showSection('dashboard')">
                        <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                        <h3>Analytics Dashboard</h3>
                        <p>Visualize predictions and consumption patterns with interactive charts and insights.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Guide Section -->
        <section id="guide" class="section">
            <div class="guide-section">
                <div class="guide-container">
                    <h2 style="text-align: center; margin-bottom: 40px; font-size: 36px; color: #78e08f;">
                        <i class="fas fa-book-open"></i> User Guide
                    </h2>
                    <p style="text-align: center; margin-bottom: 50px; color: #d1d8e0; font-size: 18px;">
                        Follow these simple steps to get started with SmartEnergy AI platform
                    </p>
                    
                    <div class="guide-step">
                        <div class="guide-step-number">1</div>
                        <div class="guide-step-content">
                            <h3>Login to Your Account</h3>
                            <p>Enter your username and password to access the platform. New users can register for a free account.</p>
                            <p><strong>Note:</strong> Keep your login credentials secure. Use a strong password with letters, numbers, and symbols.</p>
                        </div>
                        <div class="guide-visual">
                            <div class="guide-icon">
                                <i class="fas fa-sign-in-alt"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="guide-step">
                        <div class="guide-step-number">2</div>
                        <div class="guide-step-content">
                            <h3>Navigate to Prediction Section</h3>
                            <p>Click on the "Predict" button in the navigation menu or use the home page feature cards.</p>
                            <p><strong>Tip:</strong> You can also use the AI Assistant to guide you through predictions step-by-step.</p>
                        </div>
                        <div class="guide-visual">
                            <div class="guide-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="guide-step">
                        <div class="guide-step-number">3</div>
                        <div class="guide-step-content">
                            <h3>Enter Your Parameters</h3>
                            <p>Fill in all the required information or upload a data file for automatic filling.</p>
                            <ul style="list-style-type: none; padding-left: 20px; margin: 15px 0;">
                                <li><i class="fas fa-thermometer-half" style="color: #78e08f;"></i> Current temperature</li>
                                <li><i class="fas fa-users" style="color: #78e08f;"></i> Number of occupants</li>
                                <li><i class="fas fa-home" style="color: #78e08f;"></i> Area of your space</li>
                                <li><i class="fas fa-calendar-alt" style="color: #78e08f;"></i> Date and time</li>
                                <li><i class="fas fa-plug" style="color: #78e08f;"></i> Active devices</li>
                            </ul>
                        </div>
                        <div class="guide-visual">
                            <div class="guide-icon">
                                <i class="fas fa-edit"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="guide-step">
                        <div class="guide-step-number">4</div>
                        <div class="guide-step-content">
                            <h3>Get Your Prediction</h3>
                            <p>Click the "Predict Energy Consumption" button to get your AI-powered energy prediction.</p>
                            <p><strong>Features:</strong> You'll see predicted consumption, estimated cost in ₹ (Rupees), carbon footprint, and savings recommendations.</p>
                        </div>
                        <div class="guide-visual">
                            <div class="guide-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="guide-step">
                        <div class="guide-step-number">5</div>
                        <div class="guide-step-content">
                            <h3>Use AI Assistant for Help</h3>
                            <p>Access the AI Assistant from the navigation menu for:</p>
                            <ul style="list-style-type: none; padding-left: 20px; margin: 15px 0;">
                                <li><i class="fas fa-robot" style="color: #78e08f;"></i> Guided step-by-step predictions</li>
                                <li><i class="fas fa-lightbulb" style="color: #78e08f;"></i> Energy saving tips</li>
                                <li><i class="fas fa-question-circle" style="color: #78e08f;"></i> Answers to your questions</li>
                                <li><i class="fas fa-calculator" style="color: #78e08f;"></i> Explanation of predictions</li>
                            </ul>
                        </div>
                        <div class="guide-visual">
                            <div class="guide-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="guide-step">
                        <div class="guide-step-number">6</div>
                        <div class="guide-step-content">
                            <h3>View Analytics & Submit Feedback</h3>
                            <p>Check the Dashboard for detailed analytics and historical data. You can also:</p>
                            <ul style="list-style-type: none; padding-left: 20px; margin: 15px 0;">
                                <li><i class="fas fa-star" style="color: #78e08f;"></i> Submit reviews and ratings</li>
                                <li><i class="fas fa-chart-line" style="color: #78e08f;"></i> Monitor consumption patterns</li>
                                <li><i class="fas fa-envelope" style="color: #78e08f;"></i> Contact us for support</li>
                            </ul>
                        </div>
                        <div class="guide-visual">
                            <div class="guide-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 50px; padding: 30px; background: rgba(120, 224, 143, 0.1); border-radius: 15px;">
                        <h3 style="color: #78e08f; margin-bottom: 15px;">
                            <i class="fas fa-graduation-cap"></i> Quick Tips
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                <i class="fas fa-file-upload" style="color: #78e08f; font-size: 24px; margin-bottom: 10px;"></i>
                                <h4>File Upload</h4>
                                <p style="font-size: 14px;">Upload data files to auto-fill prediction forms</p>
                            </div>
                            <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                <i class="fas fa-rupee-sign" style="color: #78e08f; font-size: 24px; margin-bottom: 10px;"></i>
                                <h4>Cost in ₹</h4>
                                <p style="font-size: 14px;">All costs shown in Indian Rupees</p>
                            </div>
                            <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                <i class="fas fa-history" style="color: #78e08f; font-size: 24px; margin-bottom: 10px;"></i>
                                <h4>Prediction History</h4>
                                <p style="font-size: 14px;">View your previous predictions and patterns</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Prediction Section -->
        <section id="predict" class="section">
            <div class="prediction-section">
                <div class="form-container">
                    <h2><i class="fas fa-bolt"></i> Energy Consumption Prediction</h2>
                    <p>Enter your parameters to get an accurate energy consumption prediction for your household or facility.</p>
                    
                    <!-- File Upload Section -->
                    <div class="file-upload-section" id="fileUploadSection"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event)">
                        <h3><i class="fas fa-file-upload"></i> Quick Prediction with File Upload</h3>
                        <p>Upload your energy data file for automatic prediction. We'll read the file and predict instantly!</p>
                        
                        <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h4>Drag & Drop or Click to Upload</h4>
                            <p>Upload your energy data file (.txt, .csv, .json)</p>
                            
                            <div class="file-format-info">
                                <span class="format-badge">.txt (Text File)</span>
                                <span class="format-badge">.csv (CSV File)</span>
                                <span class="format-badge">.json (JSON File)</span>
                            </div>
                            
                            <input type="file" id="fileInput" class="file-input" accept=".txt,.csv,.json,.xlsx" 
                                   onchange="handleFileUpload(event)">
                            <button class="upload-btn">
                                <i class="fas fa-file-import"></i> Choose File
                            </button>
                            
                            <p style="margin-top: 15px; font-size: 14px; color: #a5b1c2;">
                                <i class="fas fa-info-circle"></i> File will be processed automatically and prediction will be made
                            </p>
                        </div>
                        
                        <!-- File Processing Indicator -->
                        <div class="file-processing" id="fileProcessing">
                            <div class="processing-spinner">
                                <i class="fas fa-spinner"></i>
                            </div>
                            <h4>Processing Your File...</h4>
                            <p>Reading data and making prediction...</p>
                        </div>
                        
                        <!-- Auto-fill Success Message -->
                        <div class="auto-fill-success" id="autoFillSuccess">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-check-circle success-icon"></i>
                                <div>
                                    <h4 style="color: #78e08f; margin: 0;">File Processed Successfully!</h4>
                                    <p style="margin: 5px 0 0 0;">Form auto-filled and prediction completed automatically.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- File Info Display -->
                        <div class="uploaded-file-info" id="uploadedFileInfo">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-file" style="color: #78e08f; font-size: 24px;"></i>
                                <div>
                                    <h4 id="fileName">File Name</h4>
                                    <p id="fileSize">File Size</p>
                                    <p id="fileStatus" style="color: #78e08f; font-size: 14px;">Processing...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <form id="predictionForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="date"><i class="far fa-calendar-alt"></i> Date</label>
                                <input type="date" id="date" value="">
                            </div>
                            
                            <div class="form-group">
                                <label for="time"><i class="far fa-clock"></i> Time</label>
                                <input type="time" id="time" value="14:00">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="occupancy"><i class="fas fa-users"></i> Number of Occupants</label>
                                <input type="number" id="occupancy" placeholder="Enter number of people" value="3" min="1" max="20">
                            </div>
                            
                            <div class="form-group">
                                <label for="temperature"><i class="fas fa-thermometer-half"></i> Temperature (°C)</label>
                                <input type="number" id="temperature" placeholder="Enter temperature" value="25" step="0.1">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="area"><i class="fas fa-home"></i> Area (sq ft)</label>
                            <input type="number" id="area" placeholder="Enter area" value="1200">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-plug"></i> Active Devices</label>
                            <p style="color: #d1d8e0; font-size: 14px; margin-bottom: 10px;">Select devices that will be active during the prediction period:</p>
                            <div class="devices-grid" id="devicesContainer">
                                <!-- Devices will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <button type="button" class="submit-btn" onclick="makePrediction()">
                            <i class="fas fa-calculator"></i> Predict Energy Consumption
                        </button>
                    </form>
                    
                    <div class="prediction-result" id="predictionResult">
                        <h3><i class="fas fa-chart-pie"></i> Prediction Result</h3>
                        <p>Based on your inputs, the predicted energy consumption is:</p>
                        <div class="result-value" id="predictionValue">-- kWh</div>
                        
                        <div class="result-details">
                            <div class="result-item">
                                <div class="label">Peak Hours</div>
                                <div class="value" id="peakHours">--</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Estimated Cost</div>
                                <div class="value" id="estimatedCost">₹ --</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Carbon Footprint</div>
                                <div class="value" id="carbonFootprint">-- kg</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Savings Potential</div>
                                <div class="value" id="savingsPotential">-- %</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <h4><i class="fas fa-lightbulb"></i> Recommendation</h4>
                            <p id="recommendationText">Based on your usage pattern, consider turning off non-essential devices during peak hours to save energy.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section">
            <div class="dashboard-section">
                <div class="dashboard-container">
                    <h2><i class="fas fa-chart-line"></i> Analytics Dashboard</h2>
                    <p>Visualize your energy consumption patterns, predictions, and savings analysis.</p>
                    
                    <div class="dashboard-summary" id="dashboardSummary">
                        <!-- Summary cards will be inserted here by JavaScript -->
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-bar"></i> Energy Consumption Trend</h3>
                            <div class="chart-container">
                                <canvas id="energyTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-rupee-sign"></i> Cost Analysis</h3>
                            <div class="chart-container">
                                <canvas id="costChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-leaf"></i> Carbon Footprint</h3>
                            <div class="chart-container">
                                <canvas id="carbonChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-bolt"></i> Device-wise Consumption</h3>
                            <div class="chart-container">
                                <canvas id="deviceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="prediction-history">
                        <h3><i class="fas fa-history"></i> Prediction History</h3>
                        <p>Your recent energy consumption predictions:</p>
                        
                        <div class="chart-container" style="height: 400px; margin-top: 20px;">
                            <canvas id="predictionHistoryChart"></canvas>
                        </div>
                        
                        <table class="history-table" id="predictionHistoryTable">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Temperature</th>
                                    <th>Occupants</th>
                                    <th>Prediction (kWh)</th>
                                    <th>Cost (₹)</th>
                                    <th>Carbon (kg)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Prediction history will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Assistant Section -->
        <section id="ai-assistant" class="section">
            <div class="ai-assistant-section">
                <div class="form-container">
                    <h2><i class="fas fa-robot"></i> AI Energy Assistant</h2>
                    <p>I can guide you through energy predictions step by step or answer your questions. Use voice input for hands-free interaction!</p>
                    
                    <div class="suggested-questions">
                        <div class="question-chip" onclick="askQuestion('Help me predict energy consumption')">
                            <i class="fas fa-bolt"></i> Predict energy usage
                        </div>
                        <div class="question-chip" onclick="askQuestion('How can I reduce my energy bill?')">
                            <i class="fas fa-rupee-sign"></i> Reduce energy bill
                        </div>
                        <div class="question-chip" onclick="askQuestion('What affects energy consumption most?')">
                            <i class="fas fa-chart-bar"></i> Consumption factors
                        </div>
                        <div class="question-chip" onclick="askQuestion('Tell me about this project')">
                            <i class="fas fa-info-circle"></i> About the project
                        </div>
                    </div>
                    
                    <div class="ai-chat" id="chatContainer">
                        <div class="chat-message ai-message">
                            <strong>🤖 AI Energy Assistant:</strong><br><br>
                            Hello! I can help you in multiple ways:<br><br>
                            1. <strong>Step-by-step Prediction:</strong> Ask "Predict energy usage" and I'll guide you through all parameters<br>
                            2. <strong>General Questions:</strong> Ask about energy savings, consumption factors, or optimization tips<br>
                            3. <strong>Project Information:</strong> Ask "about the project" for detailed overview<br><br>
                            <strong>🎤 Voice Feature:</strong> Click the microphone button to talk to me!
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type your message here..." onkeypress="handleChatInput(event)">
                        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Send</button>
                    </div>
                    
                    <div class="voice-controls">
                        <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecognition()">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="voice-status" id="voiceStatus">
                            <i class="fas fa-info-circle"></i>
                            <span id="statusText">Click microphone to start voice input</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reviews Section -->
        <section id="reviews" class="section">
            <div class="reviews-section">
                <div class="form-container">
                    <h2><i class="fas fa-star"></i> Customer Reviews</h2>
                    <p>Share your experience with SmartEnergy AI platform</p>
                    
                    <form id="reviewForm">
                        <div class="form-group">
                            <label for="reviewName"><i class="fas fa-user"></i> Your Name</label>
                            <input type="text" id="reviewName" placeholder="Enter your name" required>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-star"></i> Rating</label>
                            <div class="star-rating" id="starRating">
                                <span class="star" data-value="1">☆</span>
                                <span class="star" data-value="2">☆</span>
                                <span class="star" data-value="3">☆</span>
                                <span class="star" data-value="4">☆</span>
                                <span class="star" data-value="5">☆</span>
                            </div>
                            <input type="hidden" id="ratingValue" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="reviewText"><i class="fas fa-comment"></i> Your Review</label>
                            <textarea id="reviewText" placeholder="Share your experience with our platform..." required></textarea>
                        </div>
                        
                        <button type="button" class="submit-btn" onclick="submitReview()">
                            <i class="fas fa-paper-plane"></i> Submit Review
                        </button>
                    </form>
                    
                    <div id="reviewsList">
                        <h3 style="margin-top: 40px; margin-bottom: 20px;">Recent Reviews</h3>
                        <!-- Reviews will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact Us Section -->
        <section id="contact" class="section">
            <div class="contact-container">
                <div class="contact-box">
                    <div class="contact-header">
                        <h2>Contact Us</h2>
                        <p>Have questions or feedback? We'd love to hear from you!</p>
                    </div>
                    
                    <!-- Flash Messages -->
                    <div class="alert-message" id="alertMessage">
                        <span id="alertText"></span>
                        <button class="alert-close" onclick="closeAlert()">&times;</button>
                    </div>
                    
                    <!-- Contact Form -->
                    <form id="contactForm" class="contact-form">
                        <!-- Name Field -->
                        <div class="form-group">
                            <label for="contactName"><i class="fas fa-user"></i> Full Name *</label>
                            <input type="text" id="contactName" placeholder="Enter your full name" required>
                        </div>
                        
                        <!-- Email Field -->
                        <div class="form-group">
                            <label for="contactEmail"><i class="fas fa-envelope"></i> Email Address *</label>
                            <input type="email" id="contactEmail" placeholder="Enter your email address" required>
                        </div>
                        
                        <!-- Message Field -->
                        <div class="form-group">
                            <label for="contactMessage"><i class="fas fa-comment-dots"></i> Your Message *</label>
                            <textarea id="contactMessage" rows="5" placeholder="Enter your message here..." required></textarea>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="button" class="contact-btn" onclick="submitContactForm()">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                        
                        <!-- Required fields note -->
                        <p class="required-note">
                            * Required fields
                        </p>
                    </form>
                    
                    <!-- How it works -->
                    <div class="how-it-works">
                        <h5><i class="fas fa-info-circle"></i> How it works:</h5>
                        <ol>
                            <li>Fill out the form with your details and message</li>
                            <li>Click "Send Message" to submit to our server</li>
                            <li>You'll receive a confirmation email from our system</li>
                            <li>Your message will be saved and our team will review it</li>
                            <li>We'll respond to your query within 24-48 hours</li>
                        </ol>
                        <p style="margin-top: 15px; color: #a5b1c2; font-size: 14px;">
                            <i class="fas fa-envelope"></i> All messages are processed through our secure backend server
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Success Modal -->
        <div class="modal" id="successModal">
            <div class="modal-content">
                <div class="modal-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Success!</h3>
                <p id="modalMessage">Your submission has been received successfully.</p>
                <button class="modal-close-btn" onclick="closeModal()">OK</button>
            </div>
        </div>

        <footer>
            <p>© 2024 SmartEnergy AI. All rights reserved.</p>
            <p style="margin-top: 10px; font-size: 14px; color: #a5b1c2;">Advanced AI-Powered Energy Management Platform | Backend Server Required</p>
        </footer>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===================== GLOBAL VARIABLES =====================
        const devices = [
            { id: 1, name: "Air Conditioner", power: 1500, icon: "snowflake" },
            { id: 2, name: "Refrigerator", power: 150, icon: "box" },
            { id: 3, name: "LED TV", power: 100, icon: "tv" },
            { id: 4, name: "Washing Machine", power: 500, icon: "tshirt" },
            { id: 5, name: "Microwave", power: 1000, icon: "temperature-high" },
            { id: 6, name: "Laptop", power: 50, icon: "laptop" },
            { id: 7, name: "Desktop PC", power: 200, icon: "desktop" },
            { id: 8, name: "Lighting", power: 100, icon: "lightbulb" },
            { id: 9, name: "Electric Heater", power: 2000, icon: "fire" },
            { id: 10, name: "Electric Oven", power: 2000, icon: "utensils" },
            { id: 11, name: "Dishwasher", power: 1200, icon: "hand-sparkles" },
            { id: 12, name: "Water Heater", power: 3000, icon: "water" },
            { id: 13, name: "Ceiling Fan", power: 75, icon: "fan" },
            { id: 14, name: "Charger", power: 25, icon: "charging-station" },
            { id: 15, name: "Gaming Console", power: 150, icon: "gamepad" }
        ];
        
        let currentUser = null;
        let predictionHistory = [];
        let charts = {
            energyTrendChart: null,
            costChart: null,
            carbonChart: null,
            deviceChart: null,
            historyChart: null
        };
        const USD_TO_INR = 83;
        
        // Voice Recognition Variables
        let isListening = false;
        let recognition = null;
        let finalTranscript = '';
        let voiceTimeout = null;
        
        let chatState = {
            mode: 'idle',
            currentStep: 0,
            predictionData: {},
            lastPrediction: null,
            awaitingSave: false,
            predictionCompleted: false
        };

        const chatbotPredictionSteps = [
            { 
                question: "What is the current temperature in °C? (e.g., '25', '30.5')", 
                field: "temperature", 
                type: "number" 
            },
            { 
                question: "How many people are in the household? (e.g., '3', '4 people')", 
                field: "occupancy", 
                type: "number" 
            },
            { 
                question: "What is the area of your space in sq ft? (e.g., '1200', '1500 sq ft')", 
                field: "area", 
                type: "number" 
            },
            { 
                question: "What date are you predicting for? You can say 'today', 'tomorrow', or use formats like '2024-12-25', '25/12/2024', 'Dec 25, 2024'", 
                field: "date", 
                type: "date" 
            },
            { 
                question: "What time of day? You can say 'morning', 'afternoon', 'evening', or use formats like '2 PM', '14:00', '8:30 AM'", 
                field: "time", 
                type: "time" 
            },
            { 
                question: "Which devices will be active? Enter device numbers (1-15) separated by commas, or type 'list devices' to see the list.\nExample: '1,2,3,8' or 'air conditioner, refrigerator, lighting'", 
                field: "devices", 
                type: "devices" 
            }
        ];

        // ===================== CONTACT FORM FUNCTIONS =====================
        async function submitContactForm() {
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const message = document.getElementById('contactMessage').value.trim();
            
            if (!name || !email || !message) {
                showAlert("Please fill all required fields.", "error");
                return;
            }
            
            if (!validateEmail(email)) {
                showAlert("Please enter a valid email address.", "error");
                return;
            }
            
            try {
                // Show loading state
                const submitBtn = document.querySelector('.contact-btn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                submitBtn.disabled = true;
                
                // Send data to Flask backend
                const response = await fetch('http://localhost:5000/api/contact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        message: message
                    })
                });
                
                const result = await response.json();
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (result.success) {
                    showAlert(result.message, "success");
                    document.getElementById('contactForm').reset();
                } else {
                    showAlert(result.error || "Failed to send message. Please try again.", "error");
                }
                
                // Auto-hide alert after 5 seconds
                setTimeout(() => {
                    closeAlert();
                }, 5000);
                
            } catch (error) {
                console.error('Contact form error:', error);
                showAlert("Network error. Please check if the backend server is running at http://localhost:5000", "error");
                
                // Reset button
                const submitBtn = document.querySelector('.contact-btn');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Message';
                submitBtn.disabled = false;
            }
        }

        function showAlert(message, type = "success") {
            const alertDiv = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            
            alertDiv.className = `alert-message show alert-${type}`;
            alertText.textContent = message;
            
            // Scroll to alert
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function closeAlert() {
            document.getElementById('alertMessage').classList.remove('show');
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // ===================== VOICE RECOGNITION FUNCTIONS =====================
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceUI(true);
                    finalTranscript = '';
                };
                
                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    updateStatusText(interimTranscript || 'Listening...');
                    
                    if (voiceTimeout) {
                        clearTimeout(voiceTimeout);
                    }
                    
                    voiceTimeout = setTimeout(() => {
                        if (isListening) {
                            recognition.stop();
                        }
                    }, 2000);
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    updateStatusText('Error: ' + event.error);
                    stopVoiceRecognition();
                };
                
                recognition.onend = function() {
                    isListening = false;
                    updateVoiceUI(false);
                    
                    if (finalTranscript.trim()) {
                        updateStatusText('Processing voice input...');
                        setTimeout(() => {
                            processVoiceInput(finalTranscript.trim());
                        }, 500);
                    } else {
                        updateStatusText('Click microphone to start voice input');
                    }
                    
                    if (voiceTimeout) {
                        clearTimeout(voiceTimeout);
                        voiceTimeout = null;
                    }
                };
                
                return true;
            } else {
                return false;
            }
        }

        function toggleVoiceRecognition() {
            if (!recognition) {
                if (!initVoiceRecognition()) {
                    updateStatusText('Voice recognition not supported in this browser');
                    return;
                }
            }
            
            if (isListening) {
                stopVoiceRecognition();
            } else {
                startVoiceRecognition();
            }
        }

        function startVoiceRecognition() {
            try {
                finalTranscript = '';
                recognition.start();
                updateStatusText('Listening... Speak now');
            } catch (e) {
                updateStatusText('Error starting voice recognition');
                console.error(e);
            }
        }

        function stopVoiceRecognition() {
            isListening = false;
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.error('Error stopping recognition:', e);
                }
            }
            updateVoiceUI(false);
        }

        function updateVoiceUI(listening) {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceStatus = document.getElementById('voiceStatus');
            
            if (listening) {
                voiceBtn.classList.add('listening');
                voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                voiceStatus.style.background = 'rgba(120, 224, 143, 0.2)';
                voiceStatus.innerHTML = `
                    <div class="mic-level"></div>
                    <span>Listening... Speak clearly</span>
                `;
            } else {
                voiceBtn.classList.remove('listening');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceStatus.style.background = 'rgba(255, 255, 255, 0.1)';
                voiceStatus.innerHTML = `
                    <i class="fas fa-info-circle"></i>
                    <span id="statusText">Click microphone to start voice input</span>
                `;
            }
        }

        function updateStatusText(text) {
            const statusText = document.getElementById('statusText');
            if (statusText) {
                statusText.textContent = text;
            }
        }

        function processVoiceInput(text) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = text;
            
            addMessage(`🎤 Voice input: "${text}"`, 'user');
            
            setTimeout(() => {
                processUserMessage(text);
            }, 800);
            
            updateStatusText('Voice input received. Ready for next input.');
        }

        // ===================== DATE PARSING FUNCTIONS =====================
        function parseDate(input) {
            const lowerInput = input.toLowerCase().trim();
            
            if (lowerInput === 'today') return new Date();
            if (lowerInput === 'tomorrow') {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow;
            }
            if (lowerInput === 'yesterday') {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                return yesterday;
            }
            
            const formats = [
                /^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/,
                /^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/,
                /^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/,
                /^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\s+(\d{1,2}),?\s+(\d{4})$/i,
                /^(\d{1,2})\s+(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*,?\s+(\d{4})$/i
            ];
            
            const monthNames = {
                jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5,
                jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11
            };
            
            for (let format of formats) {
                const match = lowerInput.match(format);
                if (match) {
                    try {
                        if (format === formats[0]) {
                            const [_, year, month, day] = match;
                            return new Date(year, month - 1, day);
                        } else if (format === formats[1] || format === formats[2]) {
                            const [_, part1, part2, year] = match;
                            let date1 = new Date(year, part2 - 1, part1);
                            let date2 = new Date(year, part1 - 1, part2);
                            
                            if (date1.getDate() == part1 && date1.getMonth() == part2 - 1) return date1;
                            if (date2.getDate() == part2 && date2.getMonth() == part1 - 1) return date2;
                        } else if (format === formats[3]) {
                            const [_, month, day, year] = match;
                            return new Date(year, monthNames[month.toLowerCase().substring(0, 3)], day);
                        } else if (format === formats[4]) {
                            const [_, day, month, year] = match;
                            return new Date(year, monthNames[month.toLowerCase().substring(0, 3)], day);
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            
            const parsed = Date.parse(input);
            if (!isNaN(parsed)) {
                return new Date(parsed);
            }
            
            return null;
        }

        function parseTime(input) {
            const lowerInput = input.toLowerCase().trim();
            
            if (lowerInput === 'morning' || lowerInput === 'am') return '09:00';
            if (lowerInput === 'afternoon') return '14:00';
            if (lowerInput === 'evening') return '18:00';
            if (lowerInput === 'night' || lowerInput === 'pm') return '21:00';
            if (lowerInput === 'midnight') return '00:00';
            if (lowerInput === 'noon') return '12:00';
            
            const twelveHourMatch = lowerInput.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)$/i);
            if (twelveHourMatch) {
                let [_, hour, minute, period] = twelveHourMatch;
                hour = parseInt(hour);
                minute = minute ? parseInt(minute) : 0;
                
                if (period === 'pm' && hour < 12) hour += 12;
                if (period === 'am' && hour === 12) hour = 0;
                
                return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            }
            
            const twentyFourHourMatch = lowerInput.match(/^(\d{1,2}):(\d{2})$/);
            if (twentyFourHourMatch) {
                let [_, hour, minute] = twentyFourHourMatch;
                hour = parseInt(hour);
                minute = parseInt(minute);
                
                if (hour >= 0 && hour < 24 && minute >= 0 && minute < 60) {
                    return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                }
            }
            
            return null;
        }

        function parseDeviceInput(input) {
            const lowerInput = input.toLowerCase().trim();
            
            if (lowerInput === 'list devices') {
                const deviceList = devices.map((device, index) => `${index + 1}. ${device.name}`).join('\n');
                addMessage(`Available devices:\n${deviceList}\n\nPlease enter device numbers separated by commas.`, 'ai');
                return null;
            }
            
            const deviceNumbers = [];
            
            const parts = input.split(/[, ]+/).filter(part => part.trim());
            
            parts.forEach(part => {
                const num = parseInt(part);
                if (!isNaN(num) && num >= 1 && num <= 15) {
                    deviceNumbers.push(num);
                    return;
                }
                
                const foundDevice = devices.find(device => 
                    device.name.toLowerCase().includes(part.toLowerCase())
                );
                
                if (foundDevice) {
                    deviceNumbers.push(foundDevice.id);
                }
            });
            
            return [...new Set(deviceNumbers)].sort((a, b) => a - b);
        }

        function formatDateForForm(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTimeDisplay(timeString) {
            const [hour, minute] = timeString.split(':').map(Number);
            let period = 'AM';
            let displayHour = hour;
            
            if (hour >= 12) {
                period = 'PM';
                if (hour > 12) displayHour = hour - 12;
            }
            if (hour === 0) displayHour = 12;
            
            return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
        }

        // ===================== STAR RATING FUNCTIONS =====================
        function initializeStarRating() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.replaceWith(star.cloneNode(true));
            });
            
            const freshStars = document.querySelectorAll('.star');
            
            freshStars.forEach(star => {
                star.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));
                    document.getElementById('ratingValue').value = value;
                    
                    freshStars.forEach(s => {
                        const starValue = parseInt(s.getAttribute('data-value'));
                        if (starValue <= value) {
                            s.classList.add('active');
                            s.textContent = '★';
                            s.style.color = '#ffd700';
                        } else {
                            s.classList.remove('active');
                            s.textContent = '☆';
                            s.style.color = '#ddd';
                        }
                    });
                });
                
                star.addEventListener('mouseover', function() {
                    const value = parseInt(this.getAttribute('data-value'));
                    freshStars.forEach(s => {
                        const starValue = parseInt(s.getAttribute('data-value'));
                        if (starValue <= value) {
                            s.style.color = '#ffd700';
                        }
                    });
                });
                
                star.addEventListener('mouseout', function() {
                    const currentValue = parseInt(document.getElementById('ratingValue').value);
                    freshStars.forEach(s => {
                        const starValue = parseInt(s.getAttribute('data-value'));
                        if (starValue <= currentValue) {
                            s.style.color = '#ffd700';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
        }

        function submitReview() {
            const name = document.getElementById('reviewName').value.trim();
            const rating = document.getElementById('ratingValue').value;
            const reviewText = document.getElementById('reviewText').value.trim();
            
            if (!name || rating === "0" || !reviewText) {
                showModal("Please fill all fields and select a rating.", "error");
                return;
            }
            
            const review = {
                name: name,
                rating: parseInt(rating),
                text: reviewText,
                date: new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                }),
                userId: currentUser ? currentUser.username : 'guest'
            };
            
            let reviews = JSON.parse(localStorage.getItem('smartEnergyReviews')) || [];
            reviews.unshift(review);
            localStorage.setItem('smartEnergyReviews', JSON.stringify(reviews));
            
            displayReview(review);
            
            document.getElementById('reviewName').value = '';
            document.getElementById('reviewText').value = '';
            document.getElementById('ratingValue').value = "0";
            
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.classList.remove('active');
                star.textContent = '☆';
                star.style.color = '#ddd';
            });
            
            showModal("Thank you for your review! Your feedback has been submitted successfully.");
        }

        function displayReview(review) {
            const reviewsList = document.getElementById('reviewsList');
            if (!reviewsList) return;
            
            if (reviewsList.children.length === 1 && reviewsList.children[0].tagName === 'H3') {
                const heading = reviewsList.children[0];
                reviewsList.innerHTML = '';
                reviewsList.appendChild(heading);
            }
            
            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'review-card';
            
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= review.rating) {
                    starsHtml += '★';
                } else {
                    starsHtml += '☆';
                }
            }
            
            reviewDiv.innerHTML = `
                <div class="review-header">
                    <div class="review-name">${review.name}</div>
                    <div class="review-date">${review.date}</div>
                </div>
                <div class="review-stars" style="color: #ffd700;">
                    ${starsHtml}
                </div>
                <div class="review-text">${review.text}</div>
            `;
            
            reviewsList.appendChild(reviewDiv);
        }

        function loadReviews() {
            const reviews = JSON.parse(localStorage.getItem('smartEnergyReviews')) || [];
            reviews.forEach(displayReview);
        }

        // ===================== AUTHENTICATION =====================
        function showLogin() {
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
        }

        function showRegister() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'flex';
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!username || !password) {
                alert("Please enter both username and password");
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('smartEnergyUsers')) || [];
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('smartEnergyCurrentUser', JSON.stringify(user));
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainWebsite').style.display = 'block';
                document.querySelector('.navbar').style.display = 'flex';
                showSection('home');
                initializeApp();
                updateProfile();
                loadPredictionHistory();
            } else {
                alert("Invalid username or password");
            }
        }

        function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
            
            if (!name || !email || !username || !password || !confirmPassword) {
                alert("Please fill all fields");
                return;
            }
            
            if (password !== confirmPassword) {
                alert("Passwords do not match");
                return;
            }
            
            if (!validateEmail(email)) {
                alert("Please enter a valid email address");
                return;
            }
            
            if (password.length < 6) {
                alert("Password must be at least 6 characters long");
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('smartEnergyUsers')) || [];
            if (users.find(u => u.username === username)) {
                alert("Username already exists. Please choose another.");
                return;
            }
            
            const newUser = {
                id: Date.now(),
                name: name,
                email: email,
                username: username,
                password: password,
                joinedDate: new Date().toISOString(),
                predictions: 0,
                totalEnergySaved: 0,
                totalMoneySaved: 0,
                avgPrediction: 0,
                isAdmin: users.length === 0
            };
            
            users.push(newUser);
            localStorage.setItem('smartEnergyUsers', JSON.stringify(users));
            
            currentUser = newUser;
            localStorage.setItem('smartEnergyCurrentUser', JSON.stringify(newUser));
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('mainWebsite').style.display = 'block';
            document.querySelector('.navbar').style.display = 'flex';
            showSection('home');
            initializeApp();
            updateProfile();
            
            document.getElementById('registerForm').reset();
        }

        function logout() {
            if (isListening) {
                stopVoiceRecognition();
            }
            
            currentUser = null;
            localStorage.removeItem('smartEnergyCurrentUser');
            document.getElementById('mainWebsite').style.display = 'none';
            document.querySelector('.navbar').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('loginForm').reset();
        }

        // ===================== PROFILE FUNCTIONS =====================
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
            updateProfile();
        }

        function updateProfile() {
            if (!currentUser) return;
            
            document.getElementById('profileAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            
            const joinDate = new Date(currentUser.joinedDate);
            document.getElementById('profileJoinDate').textContent = joinDate.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            const userPredictions = JSON.parse(localStorage.getItem(`userPredictions_${currentUser.id}`)) || [];
            document.getElementById('profilePredictions').textContent = userPredictions.length;
            
            let totalEnergy = 0;
            let totalMoney = 0;
            let totalEnergySaved = 0;
            
            userPredictions.forEach(pred => {
                totalEnergy += parseFloat(pred.prediction);
                totalMoney += parseFloat(pred.cost);
                totalEnergySaved += parseFloat(pred.energySaved || 0);
            });
            
            const avgPrediction = userPredictions.length > 0 ? (totalEnergy / userPredictions.length).toFixed(1) : 0;
            const moneySaved = (totalEnergySaved * 0.15 * USD_TO_INR).toFixed(0);
            
            document.getElementById('profileAvgPrediction').textContent = avgPrediction;
            document.getElementById('profileEnergySaved').textContent = `${totalEnergySaved.toFixed(1)} kWh`;
            document.getElementById('profileMoneySaved').textContent = `₹${moneySaved}`;
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const profileIcon = document.querySelector('.profile-icon');
            
            if (dropdown.classList.contains('active') && 
                !dropdown.contains(event.target) && 
                !profileIcon.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // ===================== FILE UPLOAD FUNCTIONS =====================
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadSection').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadSection').classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadSection').classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload({ target: { files: files } });
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Reset UI states
            document.getElementById('fileProcessing').classList.remove('active');
            document.getElementById('autoFillSuccess').classList.remove('active');
            document.getElementById('uploadedFileInfo').classList.remove('active');
            document.getElementById('predictionResult').classList.remove('active');
            
            // First, validate the file
            if (!validateFile(file)) {
                // Show invalid file modal
                showFileErrorModal();
                return;
            }
            
            // File is valid, show processing
            document.getElementById('fileProcessing').classList.add('active');
            
            const fileInfo = document.getElementById('uploadedFileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileStatus = document.getElementById('fileStatus');
            
            fileName.textContent = file.name;
            fileSize.textContent = `Size: ${formatFileSize(file.size)}`;
            fileStatus.textContent = 'Processing file...';
            fileStatus.style.color = '#78e08f';
            fileInfo.classList.add('active');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const fileType = file.name.split('.').pop().toLowerCase();
                    
                    const extractedData = processFileContent(content, fileType);
                    
                    // Check if relevant energy data was extracted
                    if (!extractedData || Object.keys(extractedData).length === 0) {
                        throw new Error("No relevant energy data found");
                    }
                    
                    // Check if data contains at least some energy-related information
                    if (!isValidEnergyData(extractedData)) {
                        throw new Error("File does not contain relevant energy consumption data");
                    }
                    
                    // Data is valid, proceed with auto-fill
                    autoFillForm(extractedData);
                    
                    fileStatus.textContent = 'File processed successfully!';
                    fileStatus.style.color = '#78e08f';
                    
                    // Make prediction from file data
                    setTimeout(() => {
                        makePredictionFromFile(extractedData);
                    }, 500);
                    
                } catch (error) {
                    console.error('Error processing file:', error);
                    fileStatus.textContent = 'Error: ' + error.message;
                    fileStatus.style.color = '#ff6b6b';
                    
                    // Show error modal for invalid content
                    showErrorModal(error.message || "Invalid energy data format");
                } finally {
                    document.getElementById('fileProcessing').classList.remove('active');
                }
            };
            
            reader.onerror = function() {
                document.getElementById('fileProcessing').classList.remove('active');
                fileStatus.textContent = 'Error reading file';
                fileStatus.style.color = '#ff6b6b';
                showErrorModal("Failed to read file. Please try again.");
            };
            
            if (file.name.toLowerCase().endsWith('.xlsx')) {
                simulateExcelProcessing(file);
            } else {
                reader.readAsText(file);
            }
        }

        function validateFile(file) {
            const validTypes = ['txt', 'csv', 'json', 'xlsx'];
            const fileType = file.name.split('.').pop().toLowerCase();
            const maxSize = 5 * 1024 * 1024;
            
            // Check file type
            if (!validTypes.includes(fileType)) {
                return false;
            }
            
            // Check file size
            if (file.size > maxSize) {
                showErrorModal("File size too large! Maximum size is 5MB.");
                return false;
            }
            
            return true;
        }

        function showFileErrorModal() {
            document.getElementById('fileErrorModal').classList.add('active');
        }

        function closeFileErrorModal() {
            document.getElementById('fileErrorModal').classList.remove('active');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function processFileContent(content, fileType) {
            let extractedData = {};
            
            try {
                switch (fileType) {
                    case 'txt':
                        extractedData = processTextFile(content);
                        break;
                    case 'csv':
                        extractedData = processCSVFile(content);
                        break;
                    case 'json':
                        extractedData = processJSONFile(content);
                        break;
                    default:
                        throw new Error("Unsupported file type");
                }
                
                // Additional validation to ensure it's actually energy data
                if (!isRelevantEnergyFile(extractedData, content)) {
                    throw new Error("File does not contain relevant energy consumption data");
                }
                
            } catch (error) {
                throw error;
            }
            
            return extractedData;
        }

        function isRelevantEnergyFile(data, content) {
            // Check if we have at least some energy-related data
            const hasBasicData = (
                data.temperature !== undefined ||
                data.occupancy !== undefined ||
                data.area !== undefined ||
                (data.devices !== undefined && data.devices.length > 0)
            );
            
            // Check for energy-related keywords in the content
            const contentLower = content.toLowerCase();
            const hasEnergyKeywords = contentLower.includes('energy') ||
                                     contentLower.includes('power') ||
                                     contentLower.includes('consumption') ||
                                     contentLower.includes('kwh') ||
                                     contentLower.includes('electricity') ||
                                     contentLower.includes('usage') ||
                                     contentLower.includes('meter') ||
                                     contentLower.includes('reading') ||
                                     contentLower.includes('bill') ||
                                     contentLower.includes('watt') ||
                                     contentLower.includes('voltage') ||
                                     contentLower.includes('current') ||
                                     contentLower.includes('load');
            
            return hasBasicData || hasEnergyKeywords;
        }

        function processTextFile(content) {
            const data = {};
            const lines = content.split('\n');
            let foundEnergyData = false;
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine && trimmedLine.includes(':')) {
                    const [key, ...valueParts] = trimmedLine.split(':');
                    const value = valueParts.join(':').trim();
                    
                    const cleanKey = key.toLowerCase().replace(/[^a-z]/g, '');
                    
                    if (cleanKey.includes('temp')) {
                        data.temperature = parseFloat(value) || 25;
                        foundEnergyData = true;
                    } else if (cleanKey.includes('occup') || cleanKey.includes('people')) {
                        data.occupancy = parseInt(value) || 3;
                        foundEnergyData = true;
                    } else if (cleanKey.includes('area')) {
                        data.area = parseInt(value) || 1200;
                        foundEnergyData = true;
                    } else if (cleanKey.includes('date')) {
                        data.date = formatDate(value);
                        foundEnergyData = true;
                    } else if (cleanKey.includes('time')) {
                        data.time = formatTime(value);
                        foundEnergyData = true;
                    } else if (cleanKey.includes('device')) {
                        data.devices = extractDeviceNumbers(value);
                        foundEnergyData = true;
                    }
                }
            });
            
            if (!foundEnergyData) {
                throw new Error("No energy-related data found in file");
            }
            
            return data;
        }

        function processCSVFile(content) {
            const data = {};
            const lines = content.split('\n').filter(line => line.trim());
            
            if (lines.length >= 2) {
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const values = lines[1].split(',').map(v => v.trim());
                
                headers.forEach((header, index) => {
                    if (values[index]) {
                        const cleanHeader = header.replace(/[^a-z]/g, '');
                        
                        if (cleanHeader.includes('temp')) {
                            data.temperature = parseFloat(values[index]) || 25;
                        } else if (cleanHeader.includes('occup')) {
                            data.occupancy = parseInt(values[index]) || 3;
                        } else if (cleanHeader.includes('area')) {
                            data.area = parseInt(values[index]) || 1200;
                        } else if (cleanHeader.includes('date')) {
                            data.date = formatDate(values[index]);
                        } else if (cleanHeader.includes('time')) {
                            data.time = formatTime(values[index]);
                        } else if (cleanHeader.includes('device')) {
                            data.devices = extractDeviceNumbers(values[index]);
                        }
                    }
                });
            }
            
            return data;
        }

        function processJSONFile(content) {
            try {
                const jsonData = JSON.parse(content);
                const data = {};
                
                data.temperature = parseFloat(jsonData.temperature || jsonData.temp || 25);
                data.occupancy = parseInt(jsonData.occupancy || jsonData.people || jsonData.occupants || 3);
                data.area = parseInt(jsonData.area || jsonData.size || jsonData.sqft || 1200);
                data.date = formatDate(jsonData.date || jsonData.dateTime || new Date().toISOString().split('T')[0]);
                data.time = formatTime(jsonData.time || jsonData.timeOfDay || '14:00');
                data.devices = extractDeviceNumbers(jsonData.devices || jsonData.appliances || '1,2,8');
                
                return data;
            } catch (error) {
                throw new Error("Invalid JSON format or no energy data found");
            }
        }

        function simulateExcelProcessing(file) {
            setTimeout(() => {
                const simulatedData = {
                    temperature: Math.floor(Math.random() * 10) + 22,
                    occupancy: Math.floor(Math.random() * 4) + 2,
                    area: Math.floor(Math.random() * 500) + 1000,
                    date: new Date().toISOString().split('T')[0],
                    time: `${Math.floor(Math.random() * 12) + 10}:00`,
                    devices: ['1', '2', '3', '8']
                };
                
                // Check if it's a relevant file by checking file name or simulated data
                if (!isValidEnergyData(simulatedData)) {
                    showErrorModal("Excel file does not contain relevant energy data");
                    document.getElementById('fileProcessing').classList.remove('active');
                    return;
                }
                
                autoFillForm(simulatedData);
                makePredictionFromFile(simulatedData);
                
                document.getElementById('fileProcessing').classList.remove('active');
                document.getElementById('fileStatus').textContent = 'Excel file processed successfully!';
                document.getElementById('fileStatus').style.color = '#78e08f';
                
            }, 1500);
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return new Date().toISOString().split('T')[0];
                }
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            } catch {
                return new Date().toISOString().split('T')[0];
            }
        }

        function formatTime(timeString) {
            if (timeString.match(/^\d{1,2}:\d{2}$/)) {
                return timeString;
            } else if (timeString.match(/^\d{1,2}(am|pm)$/i)) {
                const match = timeString.match(/^(\d{1,2})(am|pm)$/i);
                let hour = parseInt(match[1]);
                const period = match[2].toLowerCase();
                
                if (period === 'pm' && hour < 12) hour += 12;
                if (period === 'am' && hour === 12) hour = 0;
                
                return `${hour.toString().padStart(2, '0')}:00`;
            }
            return '14:00';
        }

        function extractDeviceNumbers(deviceString) {
            if (!deviceString) return ['1', '2', '8'];
            
            const numbers = deviceString.split(/[,;]/).map(num => {
                const parsed = parseInt(num.trim());
                return isNaN(parsed) ? null : parsed;
            }).filter(num => num !== null && num >= 1 && num <= 15);
            
            return numbers.length > 0 ? numbers.map(String) : ['1', '2', '8'];
        }

        function isValidEnergyData(data) {
            // Check for basic energy-related data
            const hasBasicData = (
                data.temperature !== undefined ||
                data.occupancy !== undefined ||
                data.area !== undefined ||
                (data.devices !== undefined && data.devices.length > 0)
            );
            
            return hasBasicData;
        }

        function autoFillForm(data) {
            if (data.temperature !== undefined) {
                document.getElementById('temperature').value = data.temperature;
            }
            if (data.occupancy !== undefined) {
                document.getElementById('occupancy').value = data.occupancy;
            }
            if (data.area !== undefined) {
                document.getElementById('area').value = data.area;
            }
            if (data.date) {
                document.getElementById('date').value = data.date;
            } else {
                setDefaultDate();
            }
            if (data.time) {
                document.getElementById('time').value = data.time;
            } else {
                document.getElementById('time').value = '14:00';
            }
            
            if (data.devices && Array.isArray(data.devices)) {
                document.querySelectorAll('.device-checkbox input').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                data.devices.forEach(deviceId => {
                    const deviceNum = parseInt(deviceId);
                    if (!isNaN(deviceNum) && deviceNum >= 1 && deviceNum <= 15) {
                        const checkbox = document.querySelector(`#device_${deviceNum}`);
                        if (checkbox) checkbox.checked = true;
                    }
                });
            }
            
            document.getElementById('autoFillSuccess').classList.add('active');
        }

        function makePredictionFromFile(data) {
            // First check if we have valid data to make a prediction
            if (!data || Object.keys(data).length === 0) {
                showErrorModal("Cannot make prediction: No valid energy data found in file");
                return;
            }
            
            // Check if we have minimum required data
            const hasRequiredData = data.temperature !== undefined || 
                                  data.occupancy !== undefined || 
                                  data.area !== undefined || 
                                  (data.devices && data.devices.length > 0);
            
            if (!hasRequiredData) {
                showErrorModal("Cannot make prediction: File does not contain sufficient energy data");
                return;
            }
            
            setTimeout(() => {
                makePrediction();
                
                document.getElementById('autoFillSuccess').innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-check-circle success-icon"></i>
                        <div>
                            <h4 style="color: #78e08f; margin: 0;">Prediction Complete!</h4>
                            <p style="margin: 5px 0 0 0;">File processed and prediction made successfully.</p>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    const resultDiv = document.getElementById('predictionResult');
                    if (resultDiv && resultDiv.classList.contains('active')) {
                        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 1000);
                
            }, 1000);
        }
// ===================== ENHANCED FILE VALIDATION =====================
function showFileErrorModal() {
    document.getElementById('fileErrorModal').classList.add('active');
}

function closeFileErrorModal() {
    document.getElementById('fileErrorModal').classList.remove('active');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function isRelevantEnergyFile(content) {
    // Your enhanced content validation
    const contentLower = typeof content === 'string' ? content.toLowerCase() : '';
    
    const energyKeywords = [
        'energy', 'power', 'consumption', 'kwh', 'kilowatt', 'electricity',
        'usage', 'meter', 'reading', 'bill', 'watt', 'voltage', 'current',
        'load', 'temperature', 'temp', 'occupancy', 'occupants', 'people',
        'area', 'sqft', 'square feet', 'device', 'appliance', 'ac',
        'air conditioner', 'refrigerator', 'heater', 'light', 'fan',
        'tv', 'computer', 'laptop', 'oven', 'microwave', 'washer',
        'dryer', 'dishwasher'
    ];
    
    for (const keyword of energyKeywords) {
        if (contentLower.includes(keyword)) {
            return true;
        }
    }
    
    const numericalPatterns = [
        /\d+\s*(kwh|kw|w)/i,
        /\d+\s*(celsius|°c|fahrenheit|°f)/i,
        /\d+\s*(sq|square)\s*ft/i,
        /\d+\s*(people|persons|occupants)/i
    ];
    
    for (const pattern of numericalPatterns) {
        if (pattern.test(contentLower)) {
            return true;
        }
    }
    
    return false;
}

function isValidEnergyData(data) {
    // Your enhanced data validation
    const hasBasicData = (
        data.temperature !== undefined ||
        data.occupancy !== undefined ||
        data.area !== undefined ||
        (data.devices !== undefined && data.devices.length > 0)
    );
    
    return hasBasicData;
}

function makePredictionFromFile(data) {
    // Your enhanced prediction from file
    if (!data || Object.keys(data).length === 0) {
        showErrorModal("Cannot make prediction: No valid energy data found in file");
        return;
    }
    
    const hasRequiredData = data.temperature !== undefined || 
                          data.occupancy !== undefined || 
                          data.area !== undefined || 
                          (data.devices && data.devices.length > 0);
    
    if (!hasRequiredData) {
        showErrorModal("Cannot make prediction: File does not contain sufficient energy data");
        return;
    }
    
    setTimeout(() => {
        makePrediction();
        
        document.getElementById('autoFillSuccess').innerHTML = `
            <div style="display: flex; align-items: center;">
                <i class="fas fa-check-circle success-icon"></i>
                <div>
                    <h4 style="color: #78e08f; margin: 0;">Prediction Complete!</h4>
                    <p style="margin: 5px 0 0 0;">File processed and prediction made successfully.</p>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const resultDiv = document.getElementById('predictionResult');
            if (resultDiv && resultDiv.classList.contains('active')) {
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 1000);
        
    }, 1000);
}
        // ===================== ERROR MODAL FUNCTIONS =====================
        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.add('active');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.remove('active');
        }

        // ===================== NAVIGATION & UI FUNCTIONS =====================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-links a').forEach(link => {
                if (link.classList.contains('logout-btn')) return;
                link.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            const navLink = document.querySelector(`a[onclick*="${sectionId}"]`);
            if (navLink) navLink.classList.add('active');
            
            document.getElementById('profileDropdown').classList.remove('active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if (sectionId === 'dashboard') {
                initializeDashboardCharts();
            } else if (sectionId === 'predict') {
                setDefaultDate();
            } else if (sectionId === 'reviews') {
                setTimeout(() => {
                    initializeStarRating();
                }, 100);
            } else if (sectionId === 'ai-assistant') {
                if (!recognition) {
                    initVoiceRecognition();
                }
            } else if (sectionId === 'contact') {
                // Clear any existing alerts when visiting contact page
                closeAlert();
            } else {
                if (isListening) {
                    stopVoiceRecognition();
                }
            }
        }

        function initializeDevices() {
            const container = document.getElementById('devicesContainer');
            if (container) {
                container.innerHTML = '';
                devices.forEach(device => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.className = 'device-checkbox';
                    deviceDiv.innerHTML = `
                        <input type="checkbox" id="device_${device.id}" value="${device.power}" data-name="${device.name}">
                        <label for="device_${device.id}">
                            <i class="fas fa-${device.icon}"></i> ${device.name}
                        </label>
                    `;
                    container.appendChild(deviceDiv);
                });
            }
        }

        function setDefaultDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }

        // ===================== PREDICTION FUNCTIONS =====================
        async function makePrediction() {
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const occupancy = parseInt(document.getElementById('occupancy').value) || 1;
            const temp = parseFloat(document.getElementById('temperature').value) || 25;
            const area = parseInt(document.getElementById('area').value) || 1000;
            
            // Get selected devices with their power values
            let selectedDevices = [];
            let totalDevicePower = 0;
            
            document.querySelectorAll('.device-checkbox input:checked').forEach(checkbox => {
                const deviceName = checkbox.getAttribute('data-name');
                const devicePower = parseInt(checkbox.value) || 0;
                selectedDevices.push({
                    name: deviceName,
                    power: devicePower
                });
                totalDevicePower += devicePower;
            });
            
            // Get just the device names for the API
            const deviceNames = selectedDevices.map(device => device.name);
            
            try {
                const response = await fetch('http://localhost:5000/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: date,
                        time: time,
                        occupancy: occupancy,
                        temperature: temp,
                        area: area,
                        devices: deviceNames,
                        humidity: 50 // Add default humidity
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayPredictionResult(result, totalDevicePower);
                    
                    if (currentUser) {
                        savePredictionToHistory({
                            date: date,
                            time: time,
                            temperature: temp,
                            occupancy: occupancy,
                            area: area,
                            devices: deviceNames,
                            prediction: result.prediction,
                            cost: result.cost,
                            carbon: result.carbon,
                            savings_potential: result.savings_potential || 15,
                            totalDevicePower: totalDevicePower,
                            source: 'backend_api'
                        });
                        
                        updateProfile();
                    }
                    
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        initializeDashboardCharts();
                    }
                } else {
                    showModal(`Prediction failed: ${result.error}`, "error");
                }
            } catch (error) {
                console.error('Prediction API error:', error);
                // Fallback to local calculation if API fails
                calculatePredictionLocally(date, time, occupancy, temp, area, selectedDevices, totalDevicePower);
            }
        }

        function calculatePredictionLocally(date, time, occupancy, temp, area, selectedDevices, totalDevicePower) {
            // Local calculation logic
            const hour = parseInt(time.split(':')[0]);
            
            let baseConsumption = (area / 100) * 0.5;
            let occupancyFactor = occupancy * 0.2;
            let tempFactor = Math.abs(22 - temp) * 0.15;
            let deviceFactor = (totalDevicePower / 1000) * 1.2;
            
            let timeFactor;
            if (hour >= 6 && hour <= 9) {
                timeFactor = 1.1;
            } else if (hour >= 18 && hour <= 21) {
                timeFactor = 1.4;
            } else if (hour >= 22 || hour <= 5) {
                timeFactor = 0.8;
            } else {
                timeFactor = 1.0;
            }
            
            let prediction = (baseConsumption + occupancyFactor + tempFactor + deviceFactor) * timeFactor;
            prediction = Math.max(0.5, prediction).toFixed(2);
            
            const costPerKWh = 0.15 * 83; // USD to INR conversion
            const estimatedCost = (prediction * costPerKWh).toFixed(2);
            const carbonFootprint = (prediction * 0.5).toFixed(1);
            const savingsPotential = Math.min(30, Math.round((totalDevicePower / 5000) * 30));
            
            const result = {
                success: true,
                prediction: parseFloat(prediction),
                cost: parseFloat(estimatedCost),
                carbon: parseFloat(carbonFootprint),
                savings_potential: savingsPotential
            };
            
            displayPredictionResult(result, totalDevicePower);
            
            if (currentUser) {
                const deviceNames = selectedDevices.map(device => device.name);
                
                savePredictionToHistory({
                    date: date,
                    time: time,
                    temperature: temp,
                    occupancy: occupancy,
                    area: area,
                    devices: deviceNames,
                    prediction: result.prediction,
                    cost: result.cost,
                    carbon: result.carbon,
                    savings_potential: result.savings_potential,
                    totalDevicePower: totalDevicePower,
                    source: 'local_calculation'
                });
                
                updateProfile();
            }
            
            if (document.getElementById('dashboard').classList.contains('active')) {
                initializeDashboardCharts();
            }
        }

        function displayPredictionResult(result, totalDevicePower) {
            const hour = parseInt(document.getElementById('time').value.split(':')[0]);
            let peakHours;
            if (hour >= 18 && hour <= 21) {
                peakHours = "Now (Peak)";
            } else if (hour >= 6 && hour <= 9) {
                peakHours = "Now (Morning Peak)";
            } else {
                peakHours = "6-9 PM";
            }
            
            let recommendation = "";
            
            if (totalDevicePower > 3000) {
                recommendation = "Consider staggering high-power device usage to avoid peak hours and reduce load.";
            } else if (parseFloat(document.getElementById('temperature').value) < 20 || 
                       parseFloat(document.getElementById('temperature').value) > 26) {
                recommendation = "Adjust temperature to 22-24°C for optimal energy efficiency.";
            } else if (hour >= 18 && hour <= 21) {
                recommendation = "You're in peak hours. Consider delaying non-essential high-power tasks.";
            } else {
                recommendation = "Your usage pattern is efficient. Consider solar options for further savings.";
            }
            
            document.getElementById('predictionValue').textContent = `${result.prediction.toFixed(2)} kWh`;
            document.getElementById('peakHours').textContent = peakHours;
            document.getElementById('estimatedCost').textContent = `₹${result.cost.toFixed(2)}`;
            document.getElementById('carbonFootprint').textContent = `${result.carbon.toFixed(1)} kg`;
            document.getElementById('savingsPotential').textContent = `${result.savings_potential || 15}%`;
            document.getElementById('recommendationText').textContent = recommendation;
            
            const resultDiv = document.getElementById('predictionResult');
            resultDiv.classList.add('active');
            
            // Scroll to result
            setTimeout(() => {
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        function savePredictionToHistory(predictionData) {
            if (!currentUser) return;
            
            const history = JSON.parse(localStorage.getItem(`userPredictions_${currentUser.id}`)) || [];
            predictionData.timestamp = new Date().toISOString();
            predictionData.id = Date.now();
            history.unshift(predictionData);
            
            if (history.length > 50) {
                history.pop();
            }
            
            localStorage.setItem(`userPredictions_${currentUser.id}`, JSON.stringify(history));
            loadPredictionHistory();
        }

        function loadPredictionHistory() {
            if (!currentUser) return;
            
            predictionHistory = JSON.parse(localStorage.getItem(`userPredictions_${currentUser.id}`)) || [];
            updatePredictionHistoryTable();
        }

        // ===================== DASHBOARD FUNCTIONS =====================
        function initializeDashboardCharts() {
            if (!currentUser) {
                createSampleDashboard();
                return;
            }
            
            const predictions = JSON.parse(localStorage.getItem(`userPredictions_${currentUser.id}`)) || [];
            
            if (predictions.length === 0) {
                createSampleDashboard();
                return;
            }
            
            const last7Predictions = predictions.slice(0, 7).reverse();
            const labels = last7Predictions.map(p => {
                const date = new Date(p.timestamp || p.date);
                return date.toLocaleDateString('en-IN', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            });
            
            const energyData = last7Predictions.map(p => parseFloat(p.prediction) || 0);
            const costData = last7Predictions.map(p => parseFloat(p.cost) || 0);
            const carbonData = last7Predictions.map(p => parseFloat(p.carbon) || 0);
            
            const totalEnergy = energyData.reduce((a, b) => a + b, 0);
            const totalCost = costData.reduce((a, b) => a + b, 0);
            const totalCarbon = carbonData.reduce((a, b) => a + b, 0);
            const avgEnergy = (totalEnergy / energyData.length).toFixed(1);
            const avgCost = (totalCost / costData.length).toFixed(0);
            
            updateDashboardSummary(totalEnergy, totalCost, totalCarbon, avgEnergy, avgCost);
            
            createEnergyTrendChart(labels, energyData);
            createCostChart(labels, costData);
            createCarbonChart(carbonData);
            createDeviceChart(predictions);
            createPredictionHistoryChart(predictions.slice(0, 10));
            
            updatePredictionHistoryTable(predictions.slice(0, 10));
        }

        function createSampleDashboard() {
            const labels = [];
            const energyData = [];
            const costData = [];
            const carbonData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-IN', { 
                    month: 'short', 
                    day: 'numeric' 
                }));
                
                energyData.push(Math.floor(Math.random() * 20) + 30);
                costData.push(Math.floor(Math.random() * 200) + 300);
                carbonData.push(Math.floor(Math.random() * 10) + 15);
            }
            
            const totalEnergy = energyData.reduce((a, b) => a + b, 0);
            const totalCost = costData.reduce((a, b) => a + b, 0);
            const totalCarbon = carbonData.reduce((a, b) => a + b, 0);
            const avgEnergy = (totalEnergy / 7).toFixed(1);
            const avgCost = (totalCost / 7).toFixed(0);
            
            updateDashboardSummary(totalEnergy, totalCost, totalCarbon, avgEnergy, avgCost);
            
            createEnergyTrendChart(labels, energyData);
            createCostChart(labels, costData);
            createCarbonChart(carbonData);
            createDeviceChart([]);
            createPredictionHistoryChart([]);
            
            const historyTable = document.querySelector('#predictionHistoryTable tbody');
            if (historyTable) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px;">
                            <i class="fas fa-chart-line" style="font-size: 40px; color: #78e08f; margin-bottom: 15px;"></i>
                            <h4>No Predictions Yet</h4>
                            <p>Make your first energy prediction to see detailed analytics here!</p>
                            <button onclick="showSection('predict')" style="
                                background: #78e08f;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                margin-top: 10px;
                                cursor: pointer;
                            ">
                                <i class="fas fa-bolt"></i> Make Prediction
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function updateDashboardSummary(totalEnergy, totalCost, totalCarbon, avgEnergy, avgCost) {
            const summaryHTML = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3><i class="fas fa-bolt"></i> Total Energy Used</h3>
                        <div style="font-size: 32px; font-weight: bold; color: #78e08f; margin: 15px 0;">
                            ${totalEnergy.toFixed(1)} kWh
                        </div>
                        <div style="color: #d1d8e0;">
                            Average: ${avgEnergy} kWh per prediction
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-rupee-sign"></i> Total Cost</h3>
                        <div style="font-size: 32px; font-weight: bold; color: #4a69bd; margin: 15px 0;">
                            ₹${totalCost.toFixed(0)}
                        </div>
                        <div style="color: #d1d8e0;">
                            Average: ₹${avgCost} per prediction
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-leaf"></i> Carbon Footprint</h3>
                        <div style="font-size: 32px; font-weight: bold; color: #38ada9; margin: 15px 0;">
                            ${totalCarbon.toFixed(1)} kg
                        </div>
                        <div style="color: #d1d8e0;">
                            Equivalent to ${(totalCarbon / 20).toFixed(1)} trees needed
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-line"></i> Predictions Made</h3>
                        <div style="font-size: 32px; font-weight: bold; color: #ffd700; margin: 15px 0;">
                            ${document.getElementById('profilePredictions').textContent}
                        </div>
                        <div style="color: #d1d8e0;">
                            Total predictions in history
                        </div>
                    </div>
                </div>
            `;
            
            const dashboardContainer = document.querySelector('.dashboard-container');
            if (dashboardContainer) {
                const existingSummary = dashboardContainer.querySelector('.dashboard-summary');
                if (existingSummary) {
                    existingSummary.innerHTML = summaryHTML;
                } else {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'dashboard-summary';
                    summaryDiv.innerHTML = summaryHTML;
                    dashboardContainer.insertBefore(summaryDiv, dashboardContainer.firstChild.nextSibling);
                }
            }
        }

        function createEnergyTrendChart(labels, data) {
            const ctx = document.getElementById('energyTrendChart');
            if (!ctx) return;
            
            if (charts.energyTrendChart) {
                charts.energyTrendChart.destroy();
            }
            
            charts.energyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Energy Consumption (kWh)',
                        data: data,
                        borderColor: '#78e08f',
                        backgroundColor: 'rgba(120, 224, 143, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#78e08f',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#78e08f',
                            bodyColor: 'white',
                            borderColor: '#78e08f',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                font: {
                                    size: 12
                                }
                            },
                            title: {
                                display: true,
                                text: 'Energy (kWh)',
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                font: {
                                    size: 12
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function createCostChart(labels, data) {
            const ctx = document.getElementById('costChart');
            if (!ctx) return;
            
            if (charts.costChart) {
                charts.costChart.destroy();
            }
            
            charts.costChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cost (₹)',
                        data: data,
                        backgroundColor: 'rgba(74, 105, 189, 0.8)',
                        borderColor: '#4a69bd',
                        borderWidth: 2,
                        borderRadius: 5,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#4a69bd',
                            bodyColor: 'white',
                            borderColor: '#4a69bd',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Cost: ₹${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return '₹' + value;
                                }
                            },
                            title: {
                                display: true,
                                text: 'Cost in ₹',
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                font: {
                                    size: 12
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function createCarbonChart(carbonData) {
            const ctx = document.getElementById('carbonChart');
            if (!ctx) return;
            
            if (charts.carbonChart) {
                charts.carbonChart.destroy();
            }
            
            const totalCarbon = carbonData.reduce((a, b) => a + b, 0);
            const avgCarbon = carbonData.length > 0 ? (totalCarbon / carbonData.length).toFixed(1) : 0;
            
            const targetCarbon = 100;
            const actualCarbon = totalCarbon;
            
            charts.carbonChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Your Carbon', 'Remaining Budget'],
                    datasets: [{
                        data: [actualCarbon, Math.max(0, targetCarbon - actualCarbon)],
                        backgroundColor: [
                            actualCarbon > targetCarbon ? '#ff6b6b' : '#38ada9',
                            'rgba(255, 255, 255, 0.1)'
                        ],
                        borderColor: [
                            actualCarbon > targetCarbon ? '#ff5252' : '#2d978f',
                            'rgba(255, 255, 255, 0.2)'
                        ],
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#38ada9',
                            bodyColor: 'white',
                            borderColor: '#38ada9',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    if (label === 'Your Carbon') {
                                        return `${label}: ${value.toFixed(1)} kg (${((value/targetCarbon)*100).toFixed(0)}% of target)`;
                                    }
                                    return `${label}: ${value.toFixed(1)} kg`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1000
                    }
                }
            });
            
            const carbonContainer = ctx.parentElement;
            const insightsHTML = `
                <div style="margin-top: 20px; text-align: center;">
                    <div style="color: ${actualCarbon > targetCarbon ? '#ff6b6b' : '#78e08f'}; font-size: 18px; font-weight: bold;">
                        ${actualCarbon > targetCarbon ? '⚠️ Above Target' : '✅ Within Target'}
                    </div>
                    <div style="color: #d1d8e0; font-size: 14px; margin-top: 5px;">
                        Average: ${avgCarbon} kg per prediction
                    </div>
                    ${actualCarbon > targetCarbon ? 
                        `<div style="color: #ff6b6b; font-size: 12px; margin-top: 5px;">
                            You need to reduce by ${(actualCarbon - targetCarbon).toFixed(1)} kg
                        </div>` : 
                        `<div style="color: #78e08f; font-size: 12px; margin-top: 5px;">
                            You have ${(targetCarbon - actualCarbon).toFixed(1)} kg remaining
                        </div>`
                    }
                </div>
            `;
            
            const existingInsights = carbonContainer.querySelector('.carbon-insights');
            if (existingInsights) {
                existingInsights.remove();
            }
            
            const insightsDiv = document.createElement('div');
            insightsDiv.className = 'carbon-insights';
            insightsDiv.innerHTML = insightsHTML;
            carbonContainer.appendChild(insightsDiv);
        }

        function createDeviceChart(predictions) {
            const ctx = document.getElementById('deviceChart');
            if (!ctx) return;
            
            if (charts.deviceChart) {
                charts.deviceChart.destroy();
            }
            
            const deviceUsage = {};
            devices.forEach(device => {
                deviceUsage[device.name] = 0;
            });
            
            predictions.forEach(pred => {
                if (pred.devices && Array.isArray(pred.devices)) {
                    pred.devices.forEach(deviceName => {
                        deviceUsage[deviceName] = (deviceUsage[deviceName] || 0) + 1;
                    });
                }
            });
            
            const sortedDevices = Object.entries(deviceUsage)
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const deviceLabels = sortedDevices.map(([name]) => name);
            const deviceData = sortedDevices.map(([_, count]) => count);
            
            if (deviceData.length === 0) {
                deviceLabels.push('Air Conditioner', 'Refrigerator', 'Lighting', 'TV', 'Laptop');
                deviceData.push(8, 6, 10, 4, 3);
            }
            
            charts.deviceChart = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: deviceLabels,
                    datasets: [{
                        data: deviceData,
                        backgroundColor: [
                            'rgba(120, 224, 143, 0.8)',
                            'rgba(74, 105, 189, 0.8)',
                            'rgba(56, 173, 169, 0.8)',
                            'rgba(255, 215, 0, 0.8)',
                            'rgba(255, 107, 107, 0.8)'
                        ],
                        borderColor: [
                            '#78e08f',
                            '#4a69bd',
                            '#38ada9',
                            '#ffd700',
                            '#ff6b6b'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'white',
                                font: {
                                    size: 12
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#78e08f',
                            bodyColor: 'white',
                            borderColor: '#78e08f',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Used ${context.raw} times`;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                display: false
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000
                    }
                }
            });
        }

        function createPredictionHistoryChart(predictions) {
            const ctx = document.getElementById('predictionHistoryChart');
            if (!ctx) return;
            
            if (charts.historyChart) {
                charts.historyChart.destroy();
            }
            
            if (predictions.length === 0) {
                ctx.parentElement.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                        <i class="fas fa-chart-line" style="font-size: 50px; color: #78e08f; margin-bottom: 20px;"></i>
                        <h4 style="color: white; margin-bottom: 10px;">No Prediction History</h4>
                        <p style="color: #d1d8e0; text-align: center;">Make predictions to see your history visualized here.</p>
                    </div>
                `;
                return;
            }
            
            const labels = predictions.map(p => {
                const date = new Date(p.timestamp || p.date);
                return date.toLocaleDateString('en-IN', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }).reverse();
            
            const energyData = predictions.map(p => parseFloat(p.prediction) || 0).reverse();
            const costData = predictions.map(p => parseFloat(p.cost) || 0).reverse();
            
            charts.historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Energy (kWh)',
                            data: energyData,
                            borderColor: '#78e08f',
                            backgroundColor: 'rgba(120, 224, 143, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Cost (₹)',
                            data: costData,
                            borderColor: '#4a69bd',
                            backgroundColor: 'rgba(74, 105, 189, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    stacked: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#78e08f',
                            bodyColor: 'white',
                            borderColor: '#78e08f',
                            borderWidth: 1,
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                font: {
                                    size: 12
                                },
                                maxRotation: 45
                            },
                            title: {
                                display: true,
                                text: 'Date & Time',
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#78e08f',
                                font: {
                                    size: 12
                                }
                            },
                            title: {
                                display: true,
                                text: 'Energy (kWh)',
                                color: '#78e08f',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#4a69bd',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return '₹' + value;
                                }
                            },
                            title: {
                                display: true,
                                text: 'Cost (₹)',
                                color: '#4a69bd',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function updatePredictionHistoryTable(predictions) {
            const tableBody = document.querySelector('#predictionHistoryTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (predictions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #a5b1c2;">
                            <i class="fas fa-history" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            No prediction history available
                        </td>
                    </tr>
                `;
                return;
            }
            
            predictions.forEach((pred, index) => {
                const date = new Date(pred.timestamp || pred.date);
                const timeStr = pred.time || date.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 500;">${date.toLocaleDateString('en-IN')}</div>
                        <div style="font-size: 12px; color: #a5b1c2;">${timeStr}</div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-thermometer-half" style="color: #ff6b6b;"></i>
                            <span>${pred.temperature || 25}°C</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-users" style="color: #78e08f;"></i>
                            <span>${pred.occupancy || 3}</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-bolt" style="color: #ffd700;"></i>
                            <span style="font-weight: bold;">${pred.prediction || '0'} kWh</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-rupee-sign" style="color: #4a69bd;"></i>
                            <span style="font-weight: bold;">₹${pred.cost || '0'}</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-leaf" style="color: #38ada9;"></i>
                            <span>${pred.carbon || '0'} kg</span>
                        </div>
                    </td>
                `;
                
                row.style.cursor = 'pointer';
                row.onclick = () => showPredictionDetails(pred);
                
                tableBody.appendChild(row);
            });
        }

        function showPredictionDetails(prediction) {
            const detailsHTML = `
                <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-top: 20px;">
                    <h4 style="color: #78e08f; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Prediction Details
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="color: #a5b1c2; font-size: 14px;">Date & Time</div>
                            <div style="color: white; font-weight: 500;">
                                ${new Date(prediction.timestamp || prediction.date).toLocaleString('en-IN')}
                            </div>
                        </div>
                        <div>
                            <div style="color: #a5b1c2; font-size: 14px;">Temperature</div>
                            <div style="color: white; font-weight: 500;">${prediction.temperature || 25}°C</div>
                        </div>
                        <div>
                            <div style="color: #a5b1c2; font-size: 14px;">Occupants</div>
                            <div style="color: white; font-weight: 500;">${prediction.occupancy || 3} people</div>
                        </div>
                        <div>
                            <div style="color: #a5b1c2; font-size: 14px;">Area</div>
                            <div style="color: white; font-weight: 500;">${prediction.area || 1200} sq ft</div>
                        </div>
                        <div>
                            <div style="color: #a5b1c2; font-size: 14px;">Devices Used</div>
                            <div style="color: white; font-weight: 500;">
                                ${prediction.devices ? prediction.devices.join(', ') : 'None'}
                            </div>
                        </div>
                        <div>
                            <div style="color: #a5b1c2; font-size: 14px;">Peak Hours</div>
                            <div style="color: ${prediction.peakHours && prediction.peakHours.includes('Peak') ? '#ff6b6b' : '#78e08f'}; font-weight: 500;">
                                ${prediction.peakHours || 'Normal Hours'}
                            </div>
                        </div>
                        <div>
                            <div style="color: #a5b1c2; font-size: 14px;">Savings Potential</div>
                            <div style="color: #78e08f; font-weight: 500;">${prediction.savingsPotential || 0}%</div>
                        </div>
                        <div>
                            <div style="color: #a5b1c2; font-size: 14px;">Source</div>
                            <div style="color: white; font-weight: 500;">
                                <i class="fas fa-${prediction.source === 'file_upload' ? 'file-upload' : 'keyboard'}"></i>
                                ${prediction.source === 'file_upload' ? 'File Upload' : 'Manual Entry'}
                            </div>
                        </div>
                    </div>
                    ${prediction.recommendationText ? `
                        <div style="margin-top: 20px; padding: 15px; background: rgba(120, 224, 143, 0.1); border-radius: 8px; border-left: 3px solid #78e08f;">
                            <div style="color: #78e08f; font-weight: 500; margin-bottom: 5px;">
                                <i class="fas fa-lightbulb"></i> Recommendation
                            </div>
                            <div style="color: #d1d8e0;">${prediction.recommendationText}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            const modal = document.getElementById('successModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <h3>Prediction Details</h3>
                <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    ${detailsHTML}
                </div>
                <button class="modal-close-btn" onclick="closeModal()">Close</button>
            `;
            
            modal.classList.add('active');
        }

        // ===================== AI ASSISTANT FUNCTIONS =====================
        function askQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, 'user');
                input.value = '';
                
                setTimeout(() => {
                    processUserMessage(message);
                }, 800);
            }
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(text, sender) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>👤 You:</strong><br>${text}`;
            } else {
                const formattedText = text.replace(/\n/g, '<br>');
                messageDiv.innerHTML = `<strong>🤖 AI Assistant:</strong><br>${formattedText}`;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            if (chatState.predictionCompleted) {
                if (lowerMessage.includes('thank') || lowerMessage.includes('thanks')) {
                    addMessage("You're welcome! 😊 I'm glad I could help. Feel free to ask if you have any more questions about energy prediction or conservation.", 'ai');
                    chatState.predictionCompleted = false;
                    return;
                }
                chatState.predictionCompleted = false;
            }
            
            if (chatState.awaitingSave) {
                if (lowerMessage.includes('save') || lowerMessage.includes('yes') || lowerMessage === 'y') {
                    if (currentUser && chatState.lastPrediction) {
                        savePredictionToHistory(chatState.lastPrediction);
                        addMessage("✅ Prediction saved to your history! You can view it in the Dashboard.", 'ai');
                        addMessage("Thank you for using SmartEnergy AI! 🎉 Is there anything else I can help you with?", 'ai');
                        chatState.predictionCompleted = true;
                    } else {
                        addMessage("❌ Please login to save predictions to your history.", 'ai');
                    }
                } else if (lowerMessage.includes('no') || lowerMessage === 'n') {
                    addMessage("Okay, prediction not saved. Thank you for using SmartEnergy AI! 🎉 Is there anything else I can help you with?", 'ai');
                    chatState.predictionCompleted = true;
                } else {
                    addMessage("Please type 'save' or 'no' to continue.", 'ai');
                    return;
                }
                chatState.awaitingSave = false;
                return;
            }
            
            if (lowerMessage.includes('project') || lowerMessage.includes('smartenergy') || 
                lowerMessage.includes('what is this') || lowerMessage.includes('about') ||
                lowerMessage.includes('explain') || lowerMessage.includes('how does this work')) {
                explainProject();
                return;
            }
            
            if (lowerMessage.includes('predict') || lowerMessage.includes('help me predict')) {
                startPredictionFlow();
            } else if (chatState.mode === 'collecting_data') {
                handlePredictionInput(message);
            } else {
                generateGeneralResponse(message);
            }
        }

        function explainProject() {
            const projectExplanation = `🌟 **SmartEnergy AI - Project Overview** 🌟\n\n` +
                `**What is SmartEnergy AI?**\n` +
                `SmartEnergy AI is an advanced energy management platform that uses artificial intelligence to predict, analyze, and optimize energy consumption for households and commercial spaces.\n\n` +
                `**Key Features:**\n` +
                `✅ **AI-Powered Predictions** - Accurate energy consumption forecasting based on multiple parameters\n` +
                `✅ **Real-time Analytics** - Interactive dashboards with charts and insights\n` +
                `✅ **Cost Optimization** - Recommendations to reduce energy bills\n` +
                `✅ **Carbon Footprint Tracking** - Monitor and reduce environmental impact\n` +
                `✅ **Voice-enabled Assistant** - Hands-free interaction for predictions\n` +
                `✅ **File Upload Support** - Process energy data from various file formats\n\n` +
                `**How It Works:**\n` +
                `1. **Input Parameters** - Provide temperature, occupancy, area, time, and devices\n` +
                `2. **AI Analysis** - Our machine learning model processes the data\n` +
                `3. **Prediction** - Get accurate energy consumption forecasts\n` +
                `4. **Recommendations** - Receive personalized energy-saving tips\n` +
                `5. **Tracking** - Monitor your energy usage patterns over time\n\n` +
                `**Technology Stack:**\n` +
                `• Frontend: HTML5, CSS3, JavaScript\n` +
                `• Charts: Chart.js for data visualization\n` +
                `• Voice Recognition: Web Speech API\n` +
                `• Data Storage: LocalStorage for user data\n` +
                `• AI: Machine learning algorithms for predictions\n\n` +
                `**Benefits:**\n` +
                `💰 **Save Money** - Reduce energy bills by up to 30%\n` +
                `🌱 **Save Environment** - Lower carbon footprint\n` +
                `📊 **Smart Insights** - Data-driven decision making\n` +
                `⏱️ **Time Saving** - Quick predictions and analysis\n\n` +
                `**Use Cases:**\n` +
                `• Home energy management\n` +
                `• Office building optimization\n` +
                `• Educational institutions\n` +
                `• Retail stores and malls\n` +
                `• Hospitality industry\n\n` +
                `**Future Enhancements:**\n` +
                `• Integration with smart home devices\n` +
                `• Real-time energy monitoring\n` +
                `• Mobile application\n` +
                `• Advanced AI models\n` +
                `• Community energy sharing\n\n` +
                `This project was developed to address the growing need for efficient energy management in today's world. By leveraging AI technology, we aim to make energy conservation accessible and effective for everyone! 🚀\n\n` +
                `*"Empowering a sustainable future through intelligent energy management."*`;
            
            addMessage(projectExplanation, 'ai');
        }

        function startPredictionFlow() {
            chatState.mode = 'collecting_data';
            chatState.currentStep = 0;
            chatState.predictionData = {};
            
            addMessage("Great! I'll help you predict energy consumption step by step. Let's start with the first parameter.", 'ai');
            setTimeout(() => {
                askNextPredictionQuestion();
            }, 500);
        }

        function askNextPredictionQuestion() {
            if (chatState.currentStep < chatbotPredictionSteps.length) {
                const step = chatbotPredictionSteps[chatState.currentStep];
                addMessage(step.question, 'ai');
            } else {
                makeChatPrediction();
            }
        }

        function handlePredictionInput(input) {
            if (chatState.currentStep >= chatbotPredictionSteps.length) return;
            
            const step = chatbotPredictionSteps[chatState.currentStep];
            
            let isValid = true;
            let processedValue = input;
            let confirmationMessage = "";
            
            if (step.type === 'number') {
                const num = parseFloat(input);
                if (isNaN(num)) {
                    isValid = false;
                    addMessage("Please enter a valid number.", 'ai');
                } else {
                    processedValue = num;
                    
                    if (step.field === 'temperature') {
                        confirmationMessage = `Got it! Temperature set to ${num}°C.`;
                    } else if (step.field === 'occupancy') {
                        confirmationMessage = `Perfect! ${num} occupants recorded.`;
                    } else if (step.field === 'area') {
                        confirmationMessage = `Great! Area set to ${num} sq ft.`;
                    } else {
                        confirmationMessage = `Got it!`;
                    }
                }
            } else if (step.type === 'date') {
                const parsedDate = parseDate(input);
                if (!parsedDate) {
                    isValid = false;
                    addMessage("Please enter a valid date (e.g., 'today', 'tomorrow', '2024-12-25', '25/12/2024', 'Dec 25, 2024').", 'ai');
                } else {
                    processedValue = formatDateForForm(parsedDate);
                    const formattedDate = parsedDate.toLocaleDateString('en-IN', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    confirmationMessage = `Perfect! Date set to ${formattedDate}.`;
                }
            } else if (step.type === 'time') {
                const parsedTime = parseTime(input);
                if (!parsedTime) {
                    isValid = false;
                    addMessage("Please enter a valid time (e.g., '2 PM', '14:00', '8:30 AM', 'evening', 'morning').", 'ai');
                } else {
                    processedValue = parsedTime;
                                        confirmationMessage = `Great! Time set to ${formatTimeDisplay(parsedTime)}.`;
                }
            } else if (step.type === 'devices') {
                const devices = parseDeviceInput(input);
                if (devices === null) {
                    return;
                }
                if (devices.length === 0) {
                    isValid = false;
                    addMessage("No valid devices found. Please enter device numbers (1-15) or names.", 'ai');
                } else {
                    processedValue = devices;
                    const deviceNames = devices.map(num => {
                        const device = findDeviceById(num);
                        return device ? device.name : `Device ${num}`;
                    });
                    confirmationMessage = `Excellent! Devices selected: ${deviceNames.join(', ')}.`;
                }
            }
            
            if (isValid) {
                chatState.predictionData[step.field] = processedValue;
                
                if (confirmationMessage) {
                    addMessage(confirmationMessage, 'ai');
                }
                
                chatState.currentStep++;
                setTimeout(() => {
                    askNextPredictionQuestion();
                }, 800);
            }
        }

        function findDeviceById(id) {
            return devices.find(device => device.id === id);
        }

        async function makeChatPrediction() {
            addMessage("🎯 Perfect! I have all the information I need. Let me calculate your energy consumption prediction...", 'ai');
            
            setTimeout(async () => {
                try {
                    const response = await fetch('http://localhost:5000/api/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            date: chatState.predictionData.date || new Date().toISOString().split('T')[0],
                            time: chatState.predictionData.time || '14:00',
                            occupancy: chatState.predictionData.occupancy || 3,
                            temperature: chatState.predictionData.temperature || 25,
                            area: chatState.predictionData.area || 1200,
                            devices: chatState.predictionData.devices ? 
                                chatState.predictionData.devices.map(id => findDeviceById(id)?.name).filter(Boolean) : 
                                ['Air Conditioner', 'Refrigerator', 'Lighting'],
                            humidity: 50
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const predictionResult = {
                            date: chatState.predictionData.date,
                            time: chatState.predictionData.time,
                            temperature: chatState.predictionData.temperature,
                            occupancy: chatState.predictionData.occupancy,
                            area: chatState.predictionData.area,
                            devices: chatState.predictionData.devices?.map(id => findDeviceById(id)?.name).filter(Boolean) || [],
                            prediction: result.prediction,
                            cost: result.cost,
                            carbon: result.carbon,
                            savings_potential: result.savings_potential || 15,
                            timestamp: new Date().toISOString(),
                            source: 'ai_assistant'
                        };
                        
                        chatState.lastPrediction = predictionResult;
                        
                        const hour = parseInt(predictionResult.time.split(':')[0]);
                        let timeOfDay = 'the day';
                        if (hour >= 6 && hour <= 9) timeOfDay = 'morning hours';
                        if (hour >= 18 && hour <= 21) timeOfDay = 'evening peak hours';
                        if (hour >= 22 || hour <= 5) timeOfDay = 'night hours';
                        
                        const predictionMessage = `
                        📊 **Energy Prediction Complete!** 📊

                        **Results:**
                        ⚡ Energy Consumption: **${result.prediction.toFixed(2)} kWh**
                        💰 Estimated Cost: **₹${result.cost.toFixed(2)}**
                        🌱 Carbon Footprint: **${result.carbon.toFixed(1)} kg CO₂**
                        💡 Savings Potential: **${result.savings_potential || 15}%**

                        **Analysis:**
                        Based on your parameters, this prediction is for ${timeOfDay}.
                        
                        **Key Factors:**
                        • Temperature: ${predictionResult.temperature}°C
                        • Occupants: ${predictionResult.occupancy} people
                        • Area: ${predictionResult.area} sq ft
                        • Active Devices: ${predictionResult.devices.length}

                        **Recommendation:**
                        ${getRecommendation(result.prediction, hour, predictionResult.devices.length)}

                        Would you like to save this prediction to your history?
                        Type "save" to save or "no" to skip.
                        `;
                        
                        addMessage(predictionMessage, 'ai');
                        chatState.awaitingSave = true;
                        
                    } else {
                        addMessage(`❌ Sorry, I couldn't make a prediction. Error: ${result.error}`, 'ai');
                        chatState.mode = 'idle';
                    }
                    
                } catch (error) {
                    console.error('Chat prediction error:', error);
                    addMessage("❌ Sorry, I couldn't connect to the prediction service. Please try again later.", 'ai');
                    chatState.mode = 'idle';
                }
            }, 1500);
        }

        function getRecommendation(prediction, hour, deviceCount) {
            let recommendations = [];
            
            if (prediction > 50) {
                recommendations.push("Your predicted consumption is high. Consider reducing AC usage.");
            }
            
            if (hour >= 18 && hour <= 21) {
                recommendations.push("You're predicting for peak hours. Try shifting non-essential tasks.");
            }
            
            if (deviceCount > 8) {
                recommendations.push("You have many devices active. Consider using them sequentially.");
            }
            
            if (recommendations.length === 0) {
                recommendations.push("Your energy usage looks efficient! Keep up the good work.");
            }
            
            return recommendations.join(' ');
        }

        function generateGeneralResponse(message) {
            const lowerMessage = message.toLowerCase();
            let response = "";
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                response = "Hello! 👋 I'm your AI Energy Assistant. How can I help you today? I can help with:\n\n1. Energy consumption predictions\n2. Energy saving tips\n3. Project information\n4. Guide you through predictions step-by-step\n\nWhat would you like to know?";
            } else if (lowerMessage.includes('save') || lowerMessage.includes('reduce') || lowerMessage.includes('bill')) {
                response = `💰 **Energy Saving Tips:** 💰

                1. **Temperature Control:**
                   • Set AC to 24-26°C for optimal efficiency
                   • Use ceiling fans to complement AC
                
                2. **Lighting:**
                   • Use LED bulbs instead of incandescent
                   • Install motion sensors for common areas
                
                3. **Devices:**
                   • Unplug devices when not in use
                   • Use power strips with switches
                   • Enable power saving modes
                
                4. **Peak Hours:**
                   • Avoid heavy usage 6-9 PM
                   • Schedule tasks for off-peak hours
                
                5. **Maintenance:**
                   • Clean AC filters monthly
                   • Service appliances regularly
                   • Check for air leaks in windows/doors
                
                6. **Smart Habits:**
                   • Use natural light during day
                   • Batch similar tasks together
                   • Cook multiple items in oven at once
                
                **Quick Wins:**
                • Replace 5 incandescent bulbs with LED: Save ₹1500/year
                • Lower AC by 2°C: Save ₹2000/year
                • Unplug chargers when not in use: Save ₹500/year
                
                Want personalized tips? Ask me about your specific situation!`;
            } else if (lowerMessage.includes('factor') || lowerMessage.includes('affect') || lowerMessage.includes('consumption')) {
                response = `🔍 **Key Factors Affecting Energy Consumption:** 🔍

                1. **Temperature:** Higher temperatures increase AC usage
                2. **Occupancy:** More people = more energy usage
                3. **Building Area:** Larger spaces need more energy
                4. **Time of Day:** Peak hours (6-9 PM) cost more
                5. **Devices Used:** High-power devices significantly impact consumption
                6. **Building Insulation:** Well-insulated buildings use less energy
                7. **Season:** Summer and winter have highest consumption
                8. **Device Efficiency:** Newer, Energy Star rated devices use less power
                9. **Usage Patterns:** How and when you use devices matters
                10. **Weather Conditions:** Humidity and extreme temperatures affect consumption

                **Most Significant Factors:**
                • Air Conditioner usage (40-50% of total)
                • Water Heater (15-20%)
                • Lighting (10-15%)
                • Refrigerator (8-12%)

                Want to see how these factors affect your specific situation? Ask me to help you predict energy usage!`;
            } else if (lowerMessage.includes('help') || lowerMessage.includes('how to')) {
                response = `🆘 **How to Use SmartEnergy AI:** 🆘

                **Main Features:**
                1. **Energy Prediction:**
                   • Go to Predict section
                   • Enter parameters or upload file
                   • Get instant prediction with costs

                2. **Dashboard:**
                   • View your prediction history
                   • See charts and analytics
                   • Track savings over time

                3. **AI Assistant (That's me!):**
                   • Ask questions about energy
                   • Get step-by-step prediction help
                   • Voice input available

                4. **File Upload:**
                   • Upload .txt, .csv, .json files
                   • Auto-fill prediction forms
                   • Quick predictions

                5. **Guide Section:**
                   • Step-by-step tutorials
                   • Visual explanations
                   • Best practices

                **Quick Start:**
                Say "predict energy usage" and I'll guide you through the process step by step!

                Need help with something specific? Just ask!`;
            } else {
                response = "I'm not sure I understand. I can help you with:\n\n• Energy predictions\n• Energy saving tips\n• Understanding factors that affect consumption\n• How to use this platform\n• Information about the project\n\nTry asking something like 'How can I reduce my energy bill?' or 'Help me predict energy usage'";
            }
            
            addMessage(response, 'ai');
        }

        // ===================== MODAL FUNCTIONS =====================
        function showModal(message, type = "success") {
            const modal = document.getElementById('successModal');
            const modalMessage = document.getElementById('modalMessage');
            const modalIcon = modal.querySelector('.modal-icon i');
            
            modalMessage.textContent = message;
            
            if (type === "error") {
                modalIcon.className = "fas fa-exclamation-triangle";
                modalIcon.style.color = "#ff6b6b";
            } else if (type === "warning") {
                modalIcon.className = "fas fa-exclamation-circle";
                modalIcon.style.color = "#ffd700";
            } else {
                modalIcon.className = "fas fa-check-circle";
                modalIcon.style.color = "#78e08f";
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('successModal').classList.remove('active');
        }

        // ===================== INITIALIZATION =====================
        function initializeApp() {
            initializeDevices();
            setDefaultDate();
            
            if (document.getElementById('dashboard').classList.contains('active')) {
                initializeDashboardCharts();
            }
            
            loadReviews();
            loadPredictionHistory();
            
            if (currentUser) {
                updateProfile();
            }
            
            // Initialize star rating for reviews section
            setTimeout(() => {
                initializeStarRating();
            }, 100);
            
            // Check if contact form exists and clear it
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.reset();
            }
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('smartEnergyCurrentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainWebsite').style.display = 'block';
                    document.querySelector('.navbar').style.display = 'flex';
                    initializeApp();
                    updateProfile();
                    loadPredictionHistory();
                    showSection('home');
                } catch (e) {
                    localStorage.removeItem('smartEnergyCurrentUser');
                }
            }
        }

        // ===================== EVENT LISTENERS =====================
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            // Initialize voice recognition
            initVoiceRecognition();
            
            // Initialize contact form
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitContactForm();
                });
            }
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                const modals = ['successModal', 'errorModal', 'fileErrorModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal.classList.contains('active')) {
                        const modalContent = modal.querySelector('.modal-content') || 
                                           modal.querySelector('.error-modal-content') ||
                                           modal.querySelector('.file-error-modal-content');
                        if (!modalContent.contains(event.target)) {
                            if (modalId === 'successModal') closeModal();
                            if (modalId === 'errorModal') closeErrorModal();
                            if (modalId === 'fileErrorModal') closeFileErrorModal();
                        }
                    }
                });
            });
            
            // Close modals with Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                    closeErrorModal();
                    closeFileErrorModal();
                }
            });
        });

        // ===================== HELPER FUNCTIONS =====================
        window.onload = function() {
            checkLoginStatus();
            
            // Initialize file upload area
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                const uploadArea = document.querySelector('.file-upload-area');
                if (uploadArea) {
                    uploadArea.addEventListener('click', function() {
                        fileInput.click();
                    });
                }
            }
            
            // Initialize charts on dashboard load
            if (document.getElementById('dashboard').classList.contains('active')) {
                initializeDashboardCharts();
            }
        };
    </script>
</body>
</html>