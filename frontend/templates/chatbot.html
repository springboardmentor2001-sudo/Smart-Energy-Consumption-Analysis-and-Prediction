{% extends "base.html" %}
{% block title %}Chatbot{% endblock %}

{% block content %}
<style>
    .chatbot-container {
        max-width: 800px;
        margin: 0 auto;
        height: 600px;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .chat-messages {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .message {
        max-width: 70%;
        padding: 1rem 1.5rem;
        border-radius: 20px;
        word-wrap: break-word;
    }
    
    .bot-message {
        background: white;
        align-self: flex-start;
        border: 2px solid #667eea;
        color: #333;
    }
    
    .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        align-self: flex-end;
    }
    
    .chat-input-container {
        padding: 1.5rem;
        background: white;
        border-top: 2px solid #e0e0e0;
        display: flex;
        gap: 1rem;
    }
    
    .chat-input {
        flex: 1;
        padding: 0.75rem 1.5rem;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1rem;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .send-btn:hover {
        transform: scale(1.05);
    }
    
    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .typing-indicator {
        display: none;
        align-self: flex-start;
        padding: 1rem 1.5rem;
    }
    
    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }
</style>

<div class="chatbot-container">
    <div class="chat-header">
        ðŸ¤– Smart Energy Assistant
    </div>
    
    <div class="chat-messages" id="chatMessages">
        <div class="message bot-message">
            Welcome! I am your smart energy predicting assistant. I can help you predict your energy consumption. What is the temperature at your home? (in Â°C)
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
    
    <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your answer...">
        <button class="send-btn" id="sendBtn">Send</button>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    
    const questions = [
        { key: 'temperature', question: 'What is the humidity level? (in %)', type: 'number' },
        { key: 'humidity', question: 'What is your home\'s square footage? (in sq ft)', type: 'number' },
        { key: 'square_footage', question: 'How many people are currently in your home?', type: 'number' },
        { key: 'occupancy', question: 'Is your HVAC system currently on? (yes/no)', type: 'boolean' },
        { key: 'hvac_usage', question: 'Are your lights currently on? (yes/no)', type: 'boolean' },
        { key: 'lighting_usage', question: 'Is today a holiday? (yes/no)', type: 'boolean' },
        { key: 'holiday', question: 'How much renewable energy are you using? (in kWh)', type: 'number' }
    ];
    
    let currentStep = 0;
    let userData = {};
    
    function addMessage(text, isBot = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isBot ? 'bot-message' : 'user-message'}`;
        messageDiv.textContent = text;
        chatMessages.insertBefore(messageDiv, typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function showTyping() {
        typingIndicator.style.display = 'block';
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function hideTyping() {
        typingIndicator.style.display = 'none';
    }
    
    function processAnswer(answer) {
        const currentQuestion = questions[currentStep - 1];
        
        if (currentQuestion.type === 'boolean') {
            const normalizedAnswer = answer.toLowerCase().trim();
            if (normalizedAnswer === 'yes' || normalizedAnswer === 'y') {
                userData[currentQuestion.key] = 1;
            } else if (normalizedAnswer === 'no' || normalizedAnswer === 'n') {
                userData[currentQuestion.key] = 0;
            } else {
                addMessage('Please answer with yes or no.', true);
                return false;
            }
        } else if (currentQuestion.type === 'number') {
            const numValue = parseFloat(answer);
            if (isNaN(numValue)) {
                addMessage('Please enter a valid number.', true);
                return false;
            }
            userData[currentQuestion.key] = numValue;
        }
        
        return true;
    }
    
    async function makePrediction() {
        showTyping();
        
        try {
            const response = await fetch('/chatbot/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });
            
            const result = await response.json();
            
            hideTyping();
            addMessage(`Based on your inputs, your predicted energy consumption is ${result.prediction} kWh. Would you like to make another prediction? (yes/no)`, true);
            currentStep = -1; // Special state for restart
            
        } catch (error) {
            hideTyping();
            addMessage('Sorry, there was an error making the prediction. Please try again.', true);
            console.error(error);
        }
    }
    
    async function handleSend() {
        const userAnswer = chatInput.value.trim();
        
        if (!userAnswer) return;
        
        addMessage(userAnswer, false);
        chatInput.value = '';
        
        sendBtn.disabled = true;
        showTyping();
        
        setTimeout(() => {
            hideTyping();
            
            if (currentStep === -1) {
                // Restart logic
                const normalizedAnswer = userAnswer.toLowerCase();
                if (normalizedAnswer === 'yes' || normalizedAnswer === 'y') {
                    userData = {};
                    currentStep = 0;
                    addMessage('Great! Let\'s start over. What is the temperature at your home? (in Â°C)', true);
                } else {
                    addMessage('Thank you for using the Smart Energy Assistant! Feel free to start a new prediction anytime.', true);
                }
                sendBtn.disabled = false;
                return;
            }
            
            if (currentStep === 0) {
                // First answer is temperature
                const temp = parseFloat(userAnswer);
                if (isNaN(temp)) {
                    addMessage('Please enter a valid temperature number.', true);
                    sendBtn.disabled = false;
                    return;
                }
                userData['temperature'] = temp;
                currentStep++;
                addMessage(questions[0].question, true);
            } else if (currentStep <= questions.length) {
                if (processAnswer(userAnswer)) {
                    if (currentStep < questions.length) {
                        currentStep++;
                        addMessage(questions[currentStep - 1].question, true);
                    } else {
                        // All questions answered, make prediction
                        makePrediction();
                    }
                }
            }
            
            sendBtn.disabled = false;
        }, 1000);
    }
    
    sendBtn.addEventListener('click', handleSend);
    
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSend();
        }
    });
</script>
{% endblock %}
